"use strict";(()=>{function M(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}function we(e){try{let t=new URL(e);if(t.protocol==="http:"||t.protocol==="https:")return e}catch{}return""}function Y(e,t){document.getElementById("modal-overlay")?.remove();let r=document.createElement("div");r.id="modal-overlay",r.className="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50";let n=document.createElement("div");n.className="bg-gray-800 border border-gray-700 rounded-2xl p-6 max-w-sm w-full mx-4 shadow-2xl";let o=document.createElement("p");o.className="text-white text-center mb-6 text-base leading-relaxed",o.textContent=e,n.appendChild(o);let i=document.createElement("div");if(i.className="flex gap-3 justify-center",t){let s=document.createElement("button");s.className="flex-1 py-2.5 rounded-xl bg-gray-600 hover:bg-gray-500 text-white font-semibold transition",s.textContent="\u041E\u0442\u043C\u0435\u043D\u0430",s.onclick=()=>r.remove(),i.appendChild(s);let a=document.createElement("button");a.className="flex-1 py-2.5 rounded-xl bg-red-600 hover:bg-red-500 text-white font-semibold transition",a.textContent="\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C",a.onclick=()=>{r.remove(),t()},i.appendChild(a)}else{let s=document.createElement("button");s.className="px-10 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-500 text-white font-semibold transition",s.textContent="OK",s.onclick=()=>r.remove(),i.appendChild(s)}n.appendChild(i),r.appendChild(n),r.addEventListener("click",s=>{s.target===r&&r.remove()}),document.body.appendChild(r)}function jr(e){let t=Math.floor((Date.now()-e)/6e4);if(t<1)return"\u0442\u043E\u043B\u044C\u043A\u043E \u0447\u0442\u043E";if(t<60)return`${t} \u043C\u0438\u043D. \u043D\u0430\u0437\u0430\u0434`;let r=Math.floor(t/60);return r<24?`${r} \u0447. \u043D\u0430\u0437\u0430\u0434`:`${Math.floor(r/24)} \u0434. \u043D\u0430\u0437\u0430\u0434`}function Ot(e,t){let r=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(r),o=document.createElement("a");o.href=n,o.download=t,o.click(),URL.revokeObjectURL(n)}var Br=["white","black"];var Te=["a","b","c","d","e","f","g","h"],De=["1","2","3","4","5","6","7","8"];var Qr=[...De].reverse(),Je=Te.flatMap(e=>De.map(t=>e+t)),ke=e=>e.every(t=>t>=0&&t<=7)?Je[8*e[0]+e[1]]:void 0,_e=e=>ke(e),L=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49];var Kt=Je.map(L),Wr=Je.map((e,t)=>({key:e,pos:Kt[t]}));function Ht(e){let t,r=()=>(t===void 0&&(t=e()),t);return r.clear=()=>{t=void 0},r}var zr=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;let t=performance.now()-e;return e=void 0,t}}},Se=e=>e==="white"?"black":"white",Ee=(e,t)=>(e[0]-t[0])**2+(e[1]-t[1])**2,Ze=(e,t)=>e.role===t.role&&e.color===t.color,Gr=(e,t)=>e[0]===t[0]&&e[1]===t[1],Ce=e=>(t,r)=>[(r?t[0]:7-t[0])*e.width/8,(r?7-t[1]:t[1])*e.height/8],ee=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},Dt=(e,t,r=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${r})`},ge=(e,t)=>{e.style.visibility=t?"visible":"hidden"},de=e=>{if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(e.targetTouches?.[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},Oi=Ht(()=>!("ontouchstart"in window)&&["macintosh","firefox"].every(e=>navigator.userAgent.toLowerCase().includes(e))),gt=e=>e.button===2&&!(e.ctrlKey&&Oi()),te=(e,t)=>{let r=document.createElement(e);return t&&(r.className=t),r};function mt(e,t,r){let n=L(e);return t||(n[0]=7-n[0],n[1]=7-n[1]),[r.left+r.width*n[0]/8+r.width/16,r.top+r.height*(7-n[1])/8+r.height/16]}var he=(e,t)=>Math.abs(e-t),vt=(e,t,r,n)=>he(e,r)*he(t,n)===2,Rt=(e,t,r,n)=>e===r!=(t===n),Ut=(e,t,r,n)=>he(e,r)===he(t,n)&&e!==r,Vr=(e,t,r,n)=>Rt(e,t,r,n)||Ut(e,t,r,n),Yr=(e,t,r,n)=>Math.max(he(e,r),he(t,n))===1;var Jr=(e,t,r,n,o)=>{let i=o?1:-1;return e===r&&(n===t+i||n===t+2*i&&(o?t<=1:t>=6))},Zr=(e,t,r,n)=>{let o=r-e,i=n-t;if(o&&i&&Math.abs(o)!==Math.abs(i))return[];let s=Math.sign(o),a=Math.sign(i),d=[],l=e+s,u=t+a;for(;l!==r||u!==n;)d.push([l,u]),l+=s,u+=a;return d.map(ke).filter(f=>f!==void 0)};var Ki=e=>he(e.orig.pos[0],e.dest.pos[0])<=1&&(he(e.orig.pos[0],e.dest.pos[0])===1?e.dest.pos[1]===e.orig.pos[1]+(e.color==="white"?1:-1):Jr(...e.orig.pos,...e.dest.pos,e.color==="white")),Hi=e=>vt(...e.orig.pos,...e.dest.pos),Xr=e=>Ut(...e.orig.pos,...e.dest.pos),en=e=>Rt(...e.orig.pos,...e.dest.pos),Di=e=>Xr(e)||en(e),Ri=e=>Yr(...e.orig.pos,...e.dest.pos)||e.orig.pos[1]===e.dest.pos[1]&&e.orig.pos[1]===(e.color==="white"?0:7)&&(e.orig.pos[0]===4&&(e.dest.pos[0]===2&&e.rookFilesFriendlies.includes(0)||e.dest.pos[0]===6&&e.rookFilesFriendlies.includes(7))||e.rookFilesFriendlies.includes(e.dest.pos[0])),Ui={pawn:Ki,knight:Hi,bishop:Xr,rook:en,queen:Di,king:Ri};function jt(e,t){let r=e.pieces,n=r.get(t);if(!n||n.color===e.turnColor)return[];let o=n.color,i=new Map([...r].filter(([u,f])=>f.color===o)),s=new Map([...r].filter(([u,f])=>f.color===Se(o))),a={key:t,pos:L(t)},d=u=>Ui[n.role](u)&&e.premovable.additionalPremoveRequirements(u),l={orig:a,role:n.role,allPieces:r,friendlies:i,enemies:s,color:o,rookFilesFriendlies:Array.from(r).filter(([u,f])=>u[1]===(o==="white"?"1":"8")&&f.color===o&&f.role==="rook").map(([u])=>L(u)[0]),lastMove:e.lastMove};return Wr.filter(u=>d({...l,dest:u})).map(u=>u.key)}function G(e,...t){e&&setTimeout(()=>e(...t),1)}function tn(e){e.orientation=Se(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function rn(e,t){for(let[r,n]of t)n?e.pieces.set(r,n):e.pieces.delete(r)}function nn(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(let[r,n]of e.pieces)n.role==="king"&&n.color===t&&(e.check=r)}function ji(e,t,r,n){se(e),e.premovable.current=[t,r],G(e.premovable.events.set,t,r,n)}function ie(e){e.premovable.current&&(e.premovable.current=void 0,G(e.premovable.events.unset))}function Bi(e,t,r){ie(e),e.predroppable.current={role:t,key:r},G(e.predroppable.events.set,t,r)}function se(e){let t=e.predroppable;t.current&&(t.current=void 0,G(t.events.unset))}function Fi(e,t,r){if(!e.autoCastle)return!1;let n=e.pieces.get(t);if(!n||n.role!=="king")return!1;let o=L(t),i=L(r);if(o[1]!==0&&o[1]!==7||o[1]!==i[1])return!1;o[0]===4&&!e.pieces.has(r)&&(i[0]===6?r=_e([7,i[1]]):i[0]===2&&(r=_e([0,i[1]])));let s=e.pieces.get(r);return!s||s.color!==n.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(r),o[0]<i[0]?(e.pieces.set(_e([6,i[1]]),n),e.pieces.set(_e([5,i[1]]),s)):(e.pieces.set(_e([2,i[1]]),n),e.pieces.set(_e([3,i[1]]),s)),!0)}function Bt(e,t,r){let n=e.pieces.get(t),o=e.pieces.get(r);if(t===r||!n)return!1;let i=o&&o.color!==n.color?o:void 0;return r===e.selected&&z(e),G(e.events.move,t,r,i),Fi(e,t,r)||(e.pieces.set(r,n),e.pieces.delete(t)),e.lastMove=[t,r],e.check=void 0,G(e.events.change),i||!0}function bt(e,t,r,n){if(e.pieces.has(r))if(n)e.pieces.delete(r);else return!1;return G(e.events.dropNewPiece,t,r),e.pieces.set(r,t),e.lastMove=[r],e.check=void 0,G(e.events.change),e.movable.dests=void 0,e.turnColor=Se(e.turnColor),!0}function on(e,t,r){let n=Bt(e,t,r);return n&&(e.movable.dests=void 0,e.turnColor=Se(e.turnColor),e.animation.current=void 0),n}function Ft(e,t,r){if(yt(e,t,r)){let n=on(e,t,r);if(n){let o=e.hold.stop();z(e);let i={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:o};return n!==!0&&(i.captured=n),G(e.movable.events.after,t,r,i),!0}}else if(Wi(e,t,r))return ji(e,t,r,{ctrlKey:e.stats.ctrlKey}),z(e),!0;return z(e),!1}function xt(e,t,r,n){let o=e.pieces.get(t);o&&(Qi(e,t,r)||n)?(e.pieces.delete(t),bt(e,o,r,n),G(e.movable.events.afterNewPiece,o.role,r,{premove:!1,predrop:!1})):o&&zi(e,t,r)?Bi(e,o.role,r):(ie(e),se(e)),e.pieces.delete(t),z(e)}function Xe(e,t,r){if(G(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){z(e),e.hold.cancel();return}else if((e.selectable.enabled||r)&&e.selected!==t&&Ft(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(sn(e,t)||Wt(e,t))&&(Qt(e,t),e.hold.start())}function Qt(e,t){e.selected=t,Wt(e,t)?e.premovable.customDests||(e.premovable.dests=jt(e,t)):e.premovable.dests=void 0}function z(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function sn(e,t){let r=e.pieces.get(t);return!!r&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}var yt=(e,t,r)=>t!==r&&sn(e,t)&&(e.movable.free||!!e.movable.dests?.get(t)?.includes(r));function Qi(e,t,r){let n=e.pieces.get(t);return!!n&&(t===r||!e.pieces.has(r))&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}function Wt(e,t){let r=e.pieces.get(t);return!!r&&e.premovable.enabled&&e.movable.color===r.color&&e.turnColor!==r.color}var Wi=(e,t,r)=>t!==r&&Wt(e,t)&&(e.premovable.customDests?.get(t)??jt(e,t)).includes(r);function zi(e,t,r){let n=e.pieces.get(t),o=e.pieces.get(r);return!!n&&(!o||o.color!==e.movable.color)&&e.predroppable.enabled&&(n.role!=="pawn"||r[1]!=="1"&&r[1]!=="8")&&e.movable.color===n.color&&e.turnColor!==n.color}function an(e,t){let r=e.pieces.get(t);return!!r&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===r.color&&(e.turnColor===r.color||e.premovable.enabled))}function ln(e){let t=e.premovable.current;if(!t)return!1;let r=t[0],n=t[1],o=!1;if(yt(e,r,n)){let i=on(e,r,n);if(i){let s={premove:!0};i!==!0&&(s.captured=i),G(e.movable.events.after,r,n,s),o=!0}}return ie(e),o}function cn(e,t){let r=e.predroppable.current,n=!1;if(!r)return!1;if(t(r)){let o={role:r.role,color:e.movable.color};bt(e,o,r.key)&&(G(e.movable.events.afterNewPiece,r.role,r.key,{premove:!1,predrop:!0}),n=!0)}return se(e),n}function et(e){ie(e),se(e),z(e)}function zt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,et(e)}function ae(e,t,r){let n=Math.floor(8*(e[0]-r.left)/r.width);t||(n=7-n);let o=7-Math.floor(8*(e[1]-r.top)/r.height);return t||(o=7-o),n>=0&&n<8&&o>=0&&o<8?ke([n,o]):void 0}function dn(e,t,r,n){let o=L(e),i=Kt.filter(l=>Gr(o,l)||Vr(o[0],o[1],l[0],l[1])||vt(o[0],o[1],l[0],l[1])),a=i.map(l=>mt(_e(l),r,n)).map(l=>Ee(t,l)),[,d]=a.reduce((l,u,f)=>l[0]<u?l:[u,f],[a[0],0]);return ke(i[d])}var N=e=>e.orientation==="white";var Vt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",Gi={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Vi={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function wt(e){e==="start"&&(e=Vt);let t=new Map,r=7,n=0;for(let o of e)switch(o){case" ":case"[":return t;case"/":if(--r,r<0)return t;n=0;break;case"~":{let i=ke([n-1,r]),s=i&&t.get(i);s&&(s.promoted=!0);break}default:{let i=o.charCodeAt(0);if(i<57)n+=i-48;else{let s=o.toLowerCase(),a=ke([n,r]);a&&t.set(a,{role:Gi[s],color:o===s?"black":"white"}),++n}}}return t}function un(e){return Qr.map(t=>Te.map(r=>{let n=e.get(r+t);if(n){let o=Vi[n.role];return n.color==="white"&&(o=o.toUpperCase()),n.promoted&&(o+="~"),o}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function Yt(e,t){t.animation&&(Jt(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function kt(e,t){if(t.movable?.dests&&(e.movable.dests=void 0),t.drawable?.autoShapes&&(e.drawable.autoShapes=[]),Jt(e,t),t.fen&&(e.pieces=wt(t.fen),e.drawable.shapes=t.drawable?.shapes||[]),"check"in t&&nn(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Qt(e,e.selected),Yt(e,t),!e.movable.rookCastle&&e.movable.dests){let r=e.movable.color==="white"?"1":"8",n="e"+r,o=e.movable.dests.get(n),i=e.pieces.get(n);if(!o||!i||i.role!=="king")return;e.movable.dests.set(n,o.filter(s=>!(s==="a"+r&&o.includes("c"+r))&&!(s==="h"+r&&o.includes("g"+r))))}}function Jt(e,t){for(let r in t)r==="__proto__"||r==="constructor"||!Object.prototype.hasOwnProperty.call(t,r)||(Object.prototype.hasOwnProperty.call(e,r)&&fn(e[r])&&fn(t[r])?Jt(e[r],t[r]):e[r]=t[r])}function fn(e){if(typeof e!="object"||e===null)return!1;let t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}var me=(e,t)=>t.animation.enabled?Xi(e,t):ve(e,t);function ve(e,t){let r=e(t);return t.dom.redraw(),r}var Zt=(e,t)=>({key:e,pos:L(e),piece:t}),Ji=(e,t)=>t.sort((r,n)=>Ee(e.pos,r.pos)-Ee(e.pos,n.pos))[0];function Zi(e,t){let r=new Map,n=[],o=new Map,i=[],s=[],a=new Map,d,l,u;for(let[f,m]of e)a.set(f,Zt(f,m));for(let f of Je)d=t.pieces.get(f),l=a.get(f),d?l?Ze(d,l.piece)||(i.push(l),s.push(Zt(f,d))):s.push(Zt(f,d)):l&&i.push(l);for(let f of s)l=Ji(f,i.filter(m=>Ze(f.piece,m.piece))),l&&(u=[l.pos[0]-f.pos[0],l.pos[1]-f.pos[1]],r.set(f.key,u.concat(u)),n.push(l.key));for(let f of i)n.includes(f.key)||o.set(f.key,f.piece);return{anims:r,fadings:o}}function pn(e,t){let r=e.animation.current;if(r===void 0){e.dom.destroyed||e.dom.redrawNow();return}let n=1-(t-r.start)*r.frequency;if(n<=0)e.animation.current=void 0,e.dom.redrawNow();else{let o=es(n);for(let i of r.plan.anims.values())i[2]=i[0]*o,i[3]=i[1]*o;e.dom.redrawNow(!0),requestAnimationFrame((i=performance.now())=>pn(e,i))}}function Xi(e,t){let r=new Map(t.pieces),n=e(t),o=Zi(r,t);if(o.anims.size||o.fadings.size){let i=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:o},i||pn(t,performance.now())}else t.dom.redraw();return n}var es=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1;var ts=["green","red","blue","yellow"];function hn(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?z(e):et(e);let r=de(t),n=ae(r,N(e),e.dom.bounds());n&&(e.drawable.current={orig:n,pos:r,brush:rs(t),snapToValidMove:e.drawable.defaultSnapToValidMove},gn(e))}function gn(e){requestAnimationFrame(()=>{let t=e.drawable.current;if(t){let r=ae(t.pos,N(e),e.dom.bounds());r||(t.snapToValidMove=!1);let n=t.snapToValidMove?dn(t.orig,t.pos,N(e),e.dom.bounds()):r;n!==t.mouseSq&&(t.mouseSq=n,t.dest=n!==t.orig?n:void 0,e.dom.redrawNow()),gn(e)}})}function mn(e,t){e.drawable.current&&(e.drawable.current.pos=de(t))}function vn(e){let t=e.drawable.current;t&&(t.mouseSq&&ns(e.drawable,t),Xt(e))}function Xt(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function bn(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),xn(e.drawable))}var _t=(e,t)=>e.orig===t.orig&&e.dest===t.dest,er=(e,t)=>e.brush===t.brush;function rs(e){let t=(e.shiftKey||e.ctrlKey)&&gt(e),r=e.altKey||e.metaKey||e.getModifierState?.("AltGraph");return ts[(t?1:0)+(r?2:0)]}function ns(e,t){let r=e.shapes.find(n=>_t(n,t));r&&(e.shapes=e.shapes.filter(n=>!_t(n,t))),(!r||!er(r,t))&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),xn(e)}function xn(e){e.onChange&&e.onChange(e.shapes)}function yn(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;let r=e.dom.bounds(),n=de(t),o=ae(n,N(e),r);if(!o)return;let i=e.pieces.get(o),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnMovablePieceClick||!i||i.color!==e.turnColor)&&bn(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||i||s||is(e,n)))t.preventDefault();else if(t.touches)return;let a=!!e.premovable.current,d=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&yt(e,e.selected,o)?me(f=>Xe(f,o),e):Xe(e,o);let l=e.selected===o,u=En(e,o);if(i&&u&&l&&an(e,o)){e.draggable.current={orig:o,piece:i,origPos:n,pos:n,started:e.draggable.autoDistance&&e.stats.dragged,element:u,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},u.cgDragging=!0,u.classList.add("dragging");let f=e.dom.elements.ghost;f&&(f.className=`ghost ${i.color} ${i.role}`,ee(f,Ce(r)(L(o),N(e))),ge(f,!0)),tr(e)}else a&&ie(e),d&&se(e);e.dom.redraw()}function is(e,t){let r=N(e),n=e.dom.bounds(),o=Math.pow(e.touchIgnoreRadius*n.width/16,2)*2;for(let i of e.pieces.keys()){let s=mt(i,r,n);if(Ee(s,t)<=o)return!0}return!1}function wn(e,t,r,n){e.pieces.set("a0",t),e.dom.redraw();let i=de(r);e.draggable.current={orig:"a0",piece:t,origPos:i,pos:i,started:!0,element:()=>En(e,"a0"),originTarget:r.target,newPiece:!0,force:!!n,keyHasChanged:!1},tr(e)}function tr(e){requestAnimationFrame(()=>{let t=e.draggable.current;if(!t)return;e.animation.current?.plan.anims.has(t.orig)&&(e.animation.current=void 0);let r=e.pieces.get(t.orig);if(!r||!Ze(r,t.piece))qe(e);else if(!t.started&&Ee(t.pos,t.origPos)>=Math.pow(e.draggable.distance,2)&&(t.started=!0),t.started){if(typeof t.element=="function"){let o=t.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),t.element=o}let n=e.dom.bounds();ee(t.element,[t.pos[0]-n.left-n.width/16,t.pos[1]-n.top-n.height/16]),t.keyHasChanged||(t.keyHasChanged=t.orig!==ae(t.pos,N(e),n))}tr(e)})}function kn(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=de(t))}function _n(e,t){let r=e.draggable.current;if(!r)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&r.originTarget!==t.target&&!r.newPiece){e.draggable.current=void 0;return}ie(e),se(e);let n=de(t)||r.pos,o=ae(n,N(e),e.dom.bounds());o&&r.started&&r.orig!==o?r.newPiece?xt(e,r.orig,o,r.force):(e.stats.ctrlKey=t.ctrlKey,Ft(e,r.orig,o)&&(e.stats.dragged=!0)):r.newPiece?e.pieces.delete(r.orig):e.draggable.deleteOnDropOff&&!o&&(e.pieces.delete(r.orig),G(e.events.change)),(r.orig===r.previouslySelected||r.keyHasChanged)&&(r.orig===o||!o)?z(e):e.selectable.enabled||z(e),Sn(e),e.draggable.current=void 0,e.dom.redraw()}function qe(e){let t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,z(e),Sn(e),e.dom.redraw())}function Sn(e){let t=e.dom.elements;t.ghost&&ge(t.ghost,!1)}function En(e,t){let r=e.dom.elements.board.firstChild;for(;r;){if(r.cgKey===t&&r.tagName==="PIECE")return r;r=r.nextSibling}}function $n(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Cn(e,2),setTimeout(()=>Cn(e,void 0),120)},120)}function Cn(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Pn(e,t){function r(){tn(e),t()}return{set(n){n.orientation&&n.orientation!==e.orientation&&r(),Yt(e,n),(n.fen?me:ve)(o=>kt(o,n),e)},state:e,getFen:()=>un(e.pieces),toggleOrientation:r,setPieces(n){me(o=>rn(o,n),e)},selectSquare(n,o){n?me(i=>Xe(i,n,o),e):e.selected&&(z(e),e.dom.redraw())},move(n,o){me(i=>Bt(i,n,o),e)},newPiece(n,o){me(i=>bt(i,n,o),e)},playPremove(){if(e.premovable.current){if(me(ln,e))return!0;e.dom.redraw()}return!1},playPredrop(n){if(e.predroppable.current){let o=cn(e,n);return e.dom.redraw(),o}return!1},cancelPremove(){ve(ie,e)},cancelPredrop(){ve(se,e)},cancelMove(){ve(n=>{et(n),qe(n)},e)},stop(){ve(n=>{zt(n),qe(n)},e)},explode(n){$n(e,n)},setAutoShapes(n){ve(o=>o.drawable.autoShapes=n,e)},setShapes(n){ve(o=>o.drawable.shapes=n.slice(),e)},getKeyAtDomPos(n){return ae(n,N(e),e.dom.bounds())},redrawAll:t,dragNewPiece(n,o,i){wn(e,n,o,i)},destroy(){zt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function Mn(){return{pieces:wt(Vt),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,touchIgnoreRadius:1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,additionalPremoveRequirements:e=>!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnMovablePieceClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10},paleWhite:{key:"pwhite",color:"white",opacity:.6,lineWidth:10}},prevSvgHash:""},hold:zr()}}function qn(){let e=D("defs"),t=F(D("filter"),{id:"cg-filter-blur"});return t.appendChild(F(D("feGaussianBlur"),{stdDeviation:"0.013"})),e.appendChild(t),e}function In(e,t){let r=e.drawable,n=r.current,o=n&&n.mouseSq?n:void 0,i=new Map,s=e.dom.bounds(),a=r.autoShapes.filter(f=>!f.piece);for(let f of r.shapes.concat(a).concat(o?[o]:[])){if(!f.dest)continue;let m=i.get(f.dest)??new Set,v=Et(St(L(f.orig),e.orientation),s),b=Et(St(L(f.dest),e.orientation),s);m.add(Un(jn(v,b))),i.set(f.dest,m)}let d=[],l=o?r.shapes.findIndex(f=>_t(f,o)&&er(f,o)):-1;for(let[f,m]of r.shapes.concat(a).entries()){let v=l!==-1&&l===f;d.push({shape:m,current:!1,pendingErase:v,hash:An(m,rr(m.dest,i),!1,s,v,Tn(m.dest,i))})}o&&l===-1&&d.push({shape:o,current:!0,hash:An(o,rr(o.dest,i),!0,s,!1,Tn(o.dest,i)),pendingErase:!1});let u=d.map(f=>f.hash).join(";");u!==e.drawable.prevSvgHash&&(e.drawable.prevSvgHash=u,as(r,d,t),ls(d,t,f=>us(e,f,r.brushes,i,s)))}function as(e,t,r){for(let n of[r.shapes,r.shapesBelow]){let o=n.querySelector("defs"),i=t.filter(l=>n===r.shapesBelow==!!l.shape.below),s=new Map;for(let l of i.filter(u=>u.shape.dest&&u.shape.brush)){let u=Hn(e.brushes[l.shape.brush],l.shape.modifiers),{key:f,color:m}=Dn(l.shape);f&&m&&s.set(f,{key:f,color:m,opacity:1,lineWidth:1}),s.set(u.key,u)}let a=new Set,d=o.firstElementChild;for(;d;)a.add(d.getAttribute("cgKey")),d=d.nextElementSibling;for(let[l,u]of s.entries())a.has(l)||o.appendChild(hs(u))}}function ls(e,t,r){for(let[n,o]of[[t.shapes,t.custom],[t.shapesBelow,t.customBelow]]){let[i,s]=[n,o].map(l=>l.querySelector("g")),a=e.filter(l=>n===t.shapesBelow==!!l.shape.below),d=new Map;for(let l of a)d.set(l.hash,!1);for(let l of[i,s]){let u=[],f=l.firstElementChild,m;for(;f;)m=f.getAttribute("cgHash"),d.has(m)?d.set(m,!0):u.push(f),f=f.nextElementSibling;for(let v of u)l.removeChild(v)}for(let l of a.filter(u=>!d.get(u.hash)))for(let u of r(l))u.isCustom?s.appendChild(u.el):i.appendChild(u.el)}}function An({orig:e,dest:t,brush:r,piece:n,modifiers:o,customSvg:i,label:s,below:a},d,l,u,f,m){return[u.width,u.height,l,f&&"pendingErase",m,e,t,r,d&&"-",n&&cs(n),o&&ds(o),i&&`custom-${Ln(i.html)},${i.center?.[0]??"o"}`,s&&`label-${Ln(s.text)}`,a&&"below"].filter(v=>v).join(",")}var cs=e=>[e.color,e.role,e.scale].filter(t=>t).join(","),ds=e=>[e.lineWidth,e.hilite].filter(t=>t).join(",");function Ln(e){let t=0;for(let r=0;r<e.length;r++)t=(t<<5)-t+e.charCodeAt(r)>>>0;return t.toString()}function us(e,{shape:t,current:r,pendingErase:n,hash:o},i,s,a){let d=Et(St(L(t.orig),e.orientation),a),l=t.dest?Et(St(L(t.dest),e.orientation),a):d,u=t.brush&&Hn(i[t.brush],t.modifiers),f=s.get(t.dest),m=[];if(u){let v=F(D("g"),{cgHash:o});m.push({el:v}),d[0]!==l[0]||d[1]!==l[1]?v.appendChild(ps(t,u,d,l,r,rr(t.dest,s),n)):v.appendChild(fs(i[t.brush],d,r,a,n))}if(t.label){let v=t.label;v.fill??(v.fill=t.brush&&i[t.brush].color);let b=t.brush?void 0:"tr";m.push({el:gs(v,o,d,l,f,b),isCustom:!0})}if(t.customSvg){let v=t.customSvg.center??"orig",[b,x]=v==="label"?Bn(d,l,f).map(q=>q-.5):v==="dest"?l:d,A=F(D("g"),{transform:`translate(${b},${x})`,cgHash:o});A.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,m.push({el:A,isCustom:!0})}return m}function fs(e,t,r,n,o){let i=ms(),s=(n.width+n.height)/(4*Math.max(n.width,n.height));return F(D("circle"),{stroke:e.color,"stroke-width":i[r?0:1],fill:"none",opacity:Rn(e,r,o),cx:t[0],cy:t[1],r:s-i[1]/2})}function ps(e,t,r,n,o,i,s){function a(u){let f=bs(i&&!o),m=n[0]-r[0],v=n[1]-r[1],b=Math.atan2(v,m),x=Math.cos(b)*f,A=Math.sin(b)*f,q=Dn(e);return F(D("line"),{stroke:u?q.color:t.color,"stroke-width":vs(t,o)*(u?1.14:1),"stroke-linecap":"round","marker-end":`url(#arrowhead-${u?q.key:t.key})`,opacity:e.modifiers?.hilite&&!s?1:Rn(t,o,s),x1:r[0],y1:r[1],x2:n[0]-x,y2:n[1]-A})}if(!e.modifiers?.hilite)return a(!1);let d=F(D("g"),{opacity:t.opacity}),l=F(D("g"),{filter:"url(#cg-filter-blur)"});return l.appendChild(xs(r,n)),l.appendChild(a(!0)),d.appendChild(l),d.appendChild(a(!1)),d}function hs(e){let t=F(D("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(F(D("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function gs(e,t,r,n,o,i){let a=.4*.75**e.text.length,d=Bn(r,n,o),l=i==="tr"?.4:0,u=F(D("g"),{transform:`translate(${d[0]+l},${d[1]-l})`,cgHash:t});u.appendChild(F(D("circle"),{r:.4/2,"fill-opacity":i?1:.8,"stroke-opacity":i?1:.7,"stroke-width":.03,fill:e.fill??"#666",stroke:"white"}));let f=F(D("text"),{"font-size":a,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return f.innerHTML=e.text,u.appendChild(f),u}var St=(e,t)=>t==="white"?e:[7-e[0],7-e[1]],Nn=(e,t)=>(e%t+t)%t,On=(e,t)=>Nn(e+t,16),Kn=e=>[...e].some(t=>[-3,-2,-1,1,2,3].some(r=>e.has(On(t,r)))),rr=(e,t)=>!!e&&t.has(e)&&Kn(t.get(e)),D=e=>document.createElementNS("http://www.w3.org/2000/svg",e),Tn=(e,t)=>e&&t.has(e)?t.get(e).size:0;function F(e,t){for(let r in t)Object.prototype.hasOwnProperty.call(t,r)&&e.setAttribute(r,t[r]);return e}var Hn=(e,t)=>t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(r=>r).join("")}:e,ms=()=>[3/64,4/64],vs=(e,t)=>(e.lineWidth||10)*(t?.85:1)/64;function Dn(e){let t=e.modifiers?.hilite;return{key:t&&`hilite-${t.replace("#","")}`,color:t}}var Rn=(e,t,r)=>(e.opacity||1)*(r?.6:t?.9:1),bs=e=>(e?20:10)/64;function Et(e,t){let r=Math.min(1,t.width/t.height),n=Math.min(1,t.height/t.width);return[(e[0]-3.5)*r,(3.5-e[1])*n]}function xs(e,t){let r={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return F(D("rect"),{x:r.from[0],y:r.from[1],width:r.to[0]-r.from[0],height:r.to[1]-r.from[1],fill:"none",stroke:"none"})}var Un=e=>Nn(Math.round(e*8/Math.PI),16),jn=(e,t)=>Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI,ys=(e,t)=>Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((r,n)=>r+n*n,0));function Bn(e,t,r){let n=ys(e,t),o=jn(e,t);if(r&&(n-=33/64,Kn(r))){n-=10/64;let i=Un(o);i&1&&[-1,1].some(s=>r.has(On(i,s)))&&(n-=.4)}return[e[0]-Math.cos(o)*n,e[1]-Math.sin(o)*n].map(i=>i+.5)}function Qn(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(let u of Br)e.classList.toggle("orientation-"+u,t.orientation===u);e.classList.toggle("manipulable",!t.viewOnly);let r=te("cg-container");e.appendChild(r);let n=te("cg-board");r.appendChild(n);let o,i,s,a,d;if(t.drawable.visible&&([o,i]=["cg-shapes-below","cg-shapes"].map(u=>Fn(u,!0)),[s,a]=["cg-custom-below","cg-custom-svgs"].map(u=>Fn(u,!1)),d=te("cg-auto-pieces"),r.appendChild(o),r.appendChild(s),r.appendChild(i),r.appendChild(a),r.appendChild(d)),t.coordinates){let u=t.orientation==="black"?" black":"",f=t.ranksPosition==="left"?" left":"";if(t.coordinatesOnSquares){let m=t.orientation==="white"?v=>v+1:v=>8-v;Te.forEach((v,b)=>r.appendChild(nr(De.map(x=>v+x),"squares rank"+m(b)+u+f,b%2===0?"black":"white")))}else r.appendChild(nr(De,"ranks"+u+f,t.ranksPosition==="right"==(t.orientation==="white")?"white":"black")),r.appendChild(nr(Te,"files"+u,Se(t.orientation)))}let l;return!t.viewOnly&&t.draggable.enabled&&t.draggable.showGhost&&(l=te("piece","ghost"),ge(l,!1),r.appendChild(l)),{board:n,container:r,wrap:e,ghost:l,shapes:i,shapesBelow:o,custom:a,customBelow:s,autoPieces:d}}function Fn(e,t){let r=F(D("svg"),{class:e,viewBox:t?"-4 -4 8 8":"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"});return t&&r.appendChild(qn()),r.appendChild(D("g")),r}function nr(e,t,r){let n=te("coords",t),o;return e.forEach((i,s)=>{let a=s%2===(r==="white"?0:1);o=te("coord",`coord-${a?"light":"dark"}`),o.textContent=i,n.appendChild(o)}),n}function Wn(e,t){if(!e.dropmode.active)return;ie(e),se(e);let r=e.dropmode.piece;if(r){e.pieces.set("a0",r);let n=de(t),o=n&&ae(n,N(e),e.dom.bounds());o&&xt(e,"a0",o)}e.dom.redraw()}function Gn(e,t){let r=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&r.addEventListener("contextmenu",o=>o.preventDefault()),e.viewOnly)return;let n=ks(e);r.addEventListener("touchstart",n,{passive:!1}),r.addEventListener("mousedown",n,{passive:!1})}function Vn(e,t){let r=[];if("ResizeObserver"in window||r.push(tt(document.body,"chessground.resize",t)),!e.viewOnly){let n=zn(e,kn,mn),o=zn(e,_n,vn);for(let s of["touchmove","mousemove"])r.push(tt(document,s,n));for(let s of["touchend","mouseup"])r.push(tt(document,s,o));let i=()=>e.dom.bounds.clear();r.push(tt(document,"scroll",i,{capture:!0,passive:!0})),r.push(tt(window,"resize",i,{passive:!0}))}return()=>r.forEach(n=>n())}function tt(e,t,r,n){return e.addEventListener(t,r,n),()=>e.removeEventListener(t,r,n)}var ks=e=>t=>{e.draggable.current?qe(e):e.drawable.current?Xt(e):t.shiftKey||gt(t)?e.drawable.enabled&&hn(e,t):e.viewOnly||(e.dropmode.active?Wn(e,t):yn(e,t))},zn=(e,t,r)=>n=>{e.drawable.current?e.drawable.enabled&&r(e,n):e.viewOnly||t(e,n)};function Yn(e){let t=N(e),r=Ce(e.dom.bounds()),n=e.dom.elements.board,o=e.pieces,i=e.animation.current,s=i?i.plan.anims:new Map,a=i?i.plan.fadings:new Map,d=e.draggable.current,l=new Set,u=new Map,f=Cs(e),m=new Map,v,b,x,A,q,ne,Z,U,ye;for(b=n.firstChild;b;){if(v=b.cgKey,Zn(b))if(x=o.get(v),q=s.get(v),ne=a.get(v),A=b.cgPiece,b.cgDragging&&(!d||d.orig!==v)&&(b.classList.remove("dragging"),ee(b,r(L(v),t)),b.cgDragging=!1),!ne&&b.cgFading&&(b.cgFading=!1,b.classList.remove("fading")),x){if(q&&b.cgAnimating&&A===rt(x)){let I=L(v);I[0]+=q[2],I[1]+=q[3],b.classList.add("anim"),ee(b,r(I,t))}else b.cgAnimating&&(b.cgAnimating=!1,b.classList.remove("anim"),ee(b,r(L(v),t)),e.addPieceZIndex&&(b.style.zIndex=or(L(v),t)));A===rt(x)&&(!ne||!b.cgFading)?l.add(v):ne&&A===rt(ne)?(b.classList.add("fading"),b.cgFading=!0):ir(u,A,b)}else ir(u,A,b);else if(Xn(b)){let I=b.className;f.get(v)===I?(ge(b,!0),f.delete(v)):ir(m,I,b)}b=b.nextSibling}for(let[I,fe]of f){ye=m.get(fe)?.pop();let B=r(L(I),t);if(ye)ye.cgKey=I,ee(ye,B),ge(ye,!0);else{let V=te("square",fe);V.cgKey=I,ee(V,B),n.insertBefore(V,n.firstChild)}}for(let[I,fe]of m.entries())for(let B of fe)ge(B,!1);for(let[I,fe]of o)if(q=s.get(I),!l.has(I))if(Z=u.get(rt(fe)),U=Z&&Z.pop(),U){U.cgKey=I,U.cgFading&&(U.classList.remove("fading"),U.cgFading=!1);let B=L(I);e.addPieceZIndex&&(U.style.zIndex=or(B,t)),q&&(U.cgAnimating=!0,U.classList.add("anim"),B[0]+=q[2],B[1]+=q[3]),ee(U,r(B,t))}else{let B=rt(fe),V=te("piece",B),pe=L(I);V.cgPiece=B,V.cgKey=I,q&&(V.cgAnimating=!0,pe[0]+=q[2],pe[1]+=q[3]),ee(V,r(pe,t)),e.addPieceZIndex&&(V.style.zIndex=or(pe,t)),n.appendChild(V)}for(let I of u.values())Ss(e,I)}function Jn(e){let t=N(e),r=Ce(e.dom.bounds()),n=e.dom.elements.board.firstChild;for(;n;)(Zn(n)&&!n.cgAnimating||Xn(n))&&ee(n,r(L(n.cgKey),t)),n=n.nextSibling}function sr(e){let t=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,n=t.height/t.width,o=Math.floor(t.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,i=o*n;r.style.width=o+"px",r.style.height=i+"px",e.dom.bounds.clear(),e.addDimensionsCssVarsTo?.style.setProperty("---cg-width",o+"px"),e.addDimensionsCssVarsTo?.style.setProperty("---cg-height",i+"px")}var Zn=e=>e.tagName==="PIECE",Xn=e=>e.tagName==="SQUARE";function Ss(e,t){for(let r of t)e.dom.elements.board.removeChild(r)}function or(e,t){let n=e[1];return`${t?10-n:3+n}`}var rt=e=>`${e.color} ${e.role}`,Es=(e,t)=>e.lastMove?.[1]&&!e.pieces.has(e.lastMove[1])&&e.lastMove[0][0]==="e"&&["h","a"].includes(e.lastMove[1][0])&&e.lastMove[0][1]===e.lastMove[1][1]&&Zr(...L(e.lastMove[0]),...L(e.lastMove[1])).some(r=>e.pieces.has(r))?(t>e.lastMove[0]?"g":"c")+t[1]:t;function Cs(e){let t=new Map;if(e.lastMove&&e.highlight.lastMove)for(let[o,i]of e.lastMove.entries())be(t,o===1?Es(e,i):i,"last-move");if(e.check&&e.highlight.check&&be(t,e.check,"check"),e.selected&&(be(t,e.selected,"selected"),e.movable.showDests)){for(let o of e.movable.dests?.get(e.selected)??[])be(t,o,"move-dest"+(e.pieces.has(o)?" oc":""));for(let o of e.premovable.customDests?.get(e.selected)??e.premovable.dests??[])be(t,o,"premove-dest"+(e.pieces.has(o)?" oc":""))}let r=e.premovable.current;if(r)for(let o of r)be(t,o,"current-premove");else e.predroppable.current&&be(t,e.predroppable.current.key,"current-premove");let n=e.exploding;if(n)for(let o of n.keys)be(t,o,"exploding"+n.stage);return e.highlight.custom&&e.highlight.custom.forEach((o,i)=>{be(t,i,o)}),t}function be(e,t,r){let n=e.get(t);n?e.set(t,`${n} ${r}`):e.set(t,r)}function ir(e,t,r){let n=e.get(t);n?n.push(r):e.set(t,[r])}function eo(e,t,r){let n=new Map,o=[];for(let a of e)n.set(a.hash,!1);let i=t.firstElementChild,s;for(;i;)s=i.getAttribute("cgHash"),n.has(s)?n.set(s,!0):o.push(i),i=i.nextElementSibling;for(let a of o)t.removeChild(a);for(let a of e)n.get(a.hash)||t.appendChild(r(a))}function to(e,t){let n=e.drawable.autoShapes.filter(o=>o.piece).map(o=>({shape:o,hash:Ps(o),current:!1,pendingErase:!1}));eo(n,t,o=>$s(e,o,e.dom.bounds()))}function ro(e){let t=N(e),r=Ce(e.dom.bounds()),n=e.dom.elements.autoPieces?.firstChild;for(;n;)Dt(n,r(L(n.cgKey),t),n.cgScale),n=n.nextSibling}function $s(e,{shape:t,hash:r},n){let o=t.orig,i=t.piece?.role,s=t.piece?.color,a=t.piece?.scale,d=te("piece",`${i} ${s}`);return d.setAttribute("cgHash",r),d.cgKey=o,d.cgScale=a,Dt(d,Ce(n)(L(o),N(e)),a),d}var Ps=e=>[e.orig,e.piece?.role,e.piece?.color,e.piece?.scale].join(",");function no(e,t){let r=Mn();kt(r,t||{});function n(){let o="dom"in r?r.dom.unbind:void 0,i=Qn(e,r),s=Ht(()=>i.board.getBoundingClientRect()),a=u=>{Yn(l),i.autoPieces&&to(l,i.autoPieces),!u&&i.shapes&&In(l,i)},d=()=>{sr(l),Jn(l),i.autoPieces&&ro(l)},l=r;return l.dom={elements:i,bounds:s,redraw:As(a),redrawNow:a,unbind:o},l.drawable.prevSvgHash="",sr(l),a(!1),Gn(l,d),o||(l.dom.unbind=Vn(l,d)),l.events.insert&&l.events.insert(i),l}return Pn(n(),n)}function As(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}function oo(e,t,r="white"){return no(e,{fen:t,orientation:r,movable:{free:!1,color:void 0},draggable:{enabled:!1},selectable:{enabled:!1},animation:{enabled:!1},coordinates:!0,drawable:{enabled:!0,visible:!0}})}function Ls(e){return e!==null?{comment:e,variations:[]}:{variations:[]}}function Ts(e,t,r,n,o){let i={move:e,variations:o};return t&&(i.suffix=t),r&&(i.nag=r),n!==null&&(i.comment=n),i}function qs(...e){let[t,...r]=e,n=t;for(let o of r)o!==null&&(n.variations=[o,...o.variations],o.variations=[],n=o);return t}function Is(e,t){if(t.marker&&t.marker.comment){let r=t.root;for(;;){let n=r.variations[0];if(!n){r.comment=t.marker.comment;break}r=n}}return{headers:e,root:t.root,result:(t.marker&&t.marker.result)??void 0}}function Ns(e,t){function r(){this.constructor=e}r.prototype=t.prototype,e.prototype=new r}function je(e,t,r,n){var o=Error.call(this,e);return Object.setPrototypeOf&&Object.setPrototypeOf(o,je.prototype),o.expected=t,o.found=r,o.location=n,o.name="SyntaxError",o}Ns(je,Error);function ar(e,t,r){return r=r||" ",e.length>t?e:(t-=e.length,r+=r.repeat(t),e+r.slice(0,t))}je.prototype.format=function(e){var t="Error: "+this.message;if(this.location){var r=null,n;for(n=0;n<e.length;n++)if(e[n].source===this.location.source){r=e[n].text.split(/\r\n|\n|\r/g);break}var o=this.location.start,i=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(o):o,s=this.location.source+":"+i.line+":"+i.column;if(r){var a=this.location.end,d=ar("",i.line.toString().length," "),l=r[o.line-1],u=o.line===a.line?a.column:l.length+1,f=u-o.column||1;t+=`
 --> `+s+`
`+d+` |
`+i.line+" | "+l+`
`+d+" | "+ar("",o.column-1," ")+ar("",f,"^")}else t+=`
 at `+s}return t};je.buildMessage=function(e,t){var r={literal:function(l){return'"'+o(l.text)+'"'},class:function(l){var u=l.parts.map(function(f){return Array.isArray(f)?i(f[0])+"-"+i(f[1]):i(f)});return"["+(l.inverted?"^":"")+u.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(l){return l.description}};function n(l){return l.charCodeAt(0).toString(16).toUpperCase()}function o(l){return l.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(u){return"\\x0"+n(u)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(u){return"\\x"+n(u)})}function i(l){return l.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(u){return"\\x0"+n(u)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(u){return"\\x"+n(u)})}function s(l){return r[l.type](l)}function a(l){var u=l.map(s),f,m;if(u.sort(),u.length>0){for(f=1,m=1;f<u.length;f++)u[f-1]!==u[f]&&(u[m]=u[f],m++);u.length=m}switch(u.length){case 1:return u[0];case 2:return u[0]+" or "+u[1];default:return u.slice(0,-1).join(", ")+", or "+u[u.length-1]}}function d(l){return l?'"'+o(l)+'"':"end of input"}return"Expected "+a(e)+" but "+d(t)+" found."};function Os(e,t){t=t!==void 0?t:{};var r={},n=t.grammarSource,o={pgn:Or},i=Or,s="[",a='"',d="]",l=".",u="O-O-O",f="O-O",m="0-0-0",v="0-0",b="$",x="{",A="}",q=";",ne="(",Z=")",U="1-0",ye="0-1",I="1/2-1/2",fe="*",B=/^[a-zA-Z]/,V=/^[^"]/,pe=/^[0-9]/,yr=/^[.]/,wr=/^[a-zA-Z1-8\-=]/,Oo=/^[+#]/,kr=/^[!?]/,_r=/^[^}]/,Sr=/^[^\r\n]/,Er=/^[ \t\r\n]/,Ko=X("tag pair"),Ho=H("[",!1),Cr=H('"',!1),Do=H("]",!1),Ro=X("tag name"),It=ce([["a","z"],["A","Z"]],!1,!1),Uo=X("tag value"),$r=ce(['"'],!0,!1),jo=X("move number"),ft=ce([["0","9"]],!1,!1),Bo=H(".",!1),Pr=ce(["."],!1,!1),Fo=X("standard algebraic notation"),Qo=H("O-O-O",!1),Wo=H("O-O",!1),zo=H("0-0-0",!1),Go=H("0-0",!1),Mr=ce([["a","z"],["A","Z"],["1","8"],"-","="],!1,!1),Vo=ce(["+","#"],!1,!1),Yo=X("suffix annotation"),Ar=ce(["!","?"],!1,!1),Jo=X("NAG"),Zo=H("$",!1),Xo=X("brace comment"),ei=H("{",!1),Lr=ce(["}"],!0,!1),ti=H("}",!1),ri=X("rest of line comment"),ni=H(";",!1),Tr=ce(["\r",`
`],!0,!1),oi=X("variation"),ii=H("(",!1),si=H(")",!1),ai=X("game termination marker"),li=H("1-0",!1),ci=H("0-1",!1),di=H("1/2-1/2",!1),ui=H("*",!1),fi=X("whitespace"),qr=ce([" ","	","\r",`
`],!1,!1),pi=function(c,h){return Is(c,h)},hi=function(c){return Object.fromEntries(c)},gi=function(c,h){return[c,h]},mi=function(c,h){return{root:c,marker:h}},vi=function(c,h){return qs(Ls(c),...h.flat())},bi=function(c,h,g,E,C){return Ts(c,h,g,E,C)},xi=function(c){return c},yi=function(c){return c.replace(/[\r\n]+/g," ")},wi=function(c){return c.trim()},ki=function(c){return c},_i=function(c,h){return{result:c,comment:h}},p=t.peg$currPos|0,He=[{line:1,column:1}],oe=p,pt=t.peg$maxFailExpected||[],w=t.peg$silentFails|0,Ye;if(t.startRule){if(!(t.startRule in o))throw new Error(`Can't start parsing from rule "`+t.startRule+'".');i=o[t.startRule]}function H(c,h){return{type:"literal",text:c,ignoreCase:h}}function ce(c,h,g){return{type:"class",parts:c,inverted:h,ignoreCase:g}}function Si(){return{type:"end"}}function X(c){return{type:"other",description:c}}function Ir(c){var h=He[c],g;if(h)return h;if(c>=He.length)g=He.length-1;else for(g=c;!He[--g];);for(h=He[g],h={line:h.line,column:h.column};g<c;)e.charCodeAt(g)===10?(h.line++,h.column=1):h.column++,g++;return He[c]=h,h}function Nr(c,h,g){var E=Ir(c),C=Ir(h),T={source:n,start:{offset:c,line:E.line,column:E.column},end:{offset:h,line:C.line,column:C.column}};return T}function S(c){p<oe||(p>oe&&(oe=p,pt=[]),pt.push(c))}function Ei(c,h,g){return new je(je.buildMessage(c,h),c,h,g)}function Or(){var c,h,g;return c=p,h=Ci(),g=Mi(),c=pi(h,g),c}function Ci(){var c,h,g;for(c=p,h=[],g=Kr();g!==r;)h.push(g),g=Kr();return g=W(),c=hi(h),c}function Kr(){var c,h,g,E,C,T,Le;return w++,c=p,W(),e.charCodeAt(p)===91?(h=s,p++):(h=r,w===0&&S(Ho)),h!==r?(W(),g=$i(),g!==r?(W(),e.charCodeAt(p)===34?(E=a,p++):(E=r,w===0&&S(Cr)),E!==r?(C=Pi(),e.charCodeAt(p)===34?(T=a,p++):(T=r,w===0&&S(Cr)),T!==r?(W(),e.charCodeAt(p)===93?(Le=d,p++):(Le=r,w===0&&S(Do)),Le!==r?c=gi(g,C):(p=c,c=r)):(p=c,c=r)):(p=c,c=r)):(p=c,c=r)):(p=c,c=r),w--,c===r&&w===0&&S(Ko),c}function $i(){var c,h,g;if(w++,c=p,h=[],g=e.charAt(p),B.test(g)?p++:(g=r,w===0&&S(It)),g!==r)for(;g!==r;)h.push(g),g=e.charAt(p),B.test(g)?p++:(g=r,w===0&&S(It));else h=r;return h!==r?c=e.substring(c,p):c=h,w--,c===r&&(h=r,w===0&&S(Ro)),c}function Pi(){var c,h,g;for(w++,c=p,h=[],g=e.charAt(p),V.test(g)?p++:(g=r,w===0&&S($r));g!==r;)h.push(g),g=e.charAt(p),V.test(g)?p++:(g=r,w===0&&S($r));return c=e.substring(c,p),w--,h=r,w===0&&S(Uo),c}function Mi(){var c,h,g;return c=p,h=Hr(),W(),g=Ni(),g===r&&(g=null),W(),c=mi(h,g),c}function Hr(){var c,h,g,E;for(c=p,h=Nt(),h===r&&(h=null),g=[],E=Dr();E!==r;)g.push(E),E=Dr();return c=vi(h,g),c}function Dr(){var c,h,g,E,C,T,Le,ht;if(c=p,W(),Ai(),W(),h=Li(),h!==r){for(g=Ti(),g===r&&(g=null),E=[],C=Rr();C!==r;)E.push(C),C=Rr();for(C=W(),T=Nt(),T===r&&(T=null),Le=[],ht=Ur();ht!==r;)Le.push(ht),ht=Ur();c=bi(h,g,E,T,Le)}else p=c,c=r;return c}function Ai(){var c,h,g,E,C,T;for(w++,c=p,h=[],g=e.charAt(p),pe.test(g)?p++:(g=r,w===0&&S(ft));g!==r;)h.push(g),g=e.charAt(p),pe.test(g)?p++:(g=r,w===0&&S(ft));if(e.charCodeAt(p)===46?(g=l,p++):(g=r,w===0&&S(Bo)),g!==r){for(E=W(),C=[],T=e.charAt(p),yr.test(T)?p++:(T=r,w===0&&S(Pr));T!==r;)C.push(T),T=e.charAt(p),yr.test(T)?p++:(T=r,w===0&&S(Pr));h=[h,g,E,C],c=h}else p=c,c=r;return w--,c===r&&(h=r,w===0&&S(jo)),c}function Li(){var c,h,g,E,C,T;if(w++,c=p,h=p,e.substr(p,5)===u?(g=u,p+=5):(g=r,w===0&&S(Qo)),g===r&&(e.substr(p,3)===f?(g=f,p+=3):(g=r,w===0&&S(Wo)),g===r&&(e.substr(p,5)===m?(g=m,p+=5):(g=r,w===0&&S(zo)),g===r&&(e.substr(p,3)===v?(g=v,p+=3):(g=r,w===0&&S(Go)),g===r))))if(g=p,E=e.charAt(p),B.test(E)?p++:(E=r,w===0&&S(It)),E!==r){if(C=[],T=e.charAt(p),wr.test(T)?p++:(T=r,w===0&&S(Mr)),T!==r)for(;T!==r;)C.push(T),T=e.charAt(p),wr.test(T)?p++:(T=r,w===0&&S(Mr));else C=r;C!==r?(E=[E,C],g=E):(p=g,g=r)}else p=g,g=r;return g!==r?(E=e.charAt(p),Oo.test(E)?p++:(E=r,w===0&&S(Vo)),E===r&&(E=null),g=[g,E],h=g):(p=h,h=r),h!==r?c=e.substring(c,p):c=h,w--,c===r&&(h=r,w===0&&S(Fo)),c}function Ti(){var c,h,g;for(w++,c=p,h=[],g=e.charAt(p),kr.test(g)?p++:(g=r,w===0&&S(Ar));g!==r;)h.push(g),h.length>=2?g=r:(g=e.charAt(p),kr.test(g)?p++:(g=r,w===0&&S(Ar)));return h.length<1?(p=c,c=r):c=h,w--,c===r&&(h=r,w===0&&S(Yo)),c}function Rr(){var c,h,g,E,C;if(w++,c=p,W(),e.charCodeAt(p)===36?(h=b,p++):(h=r,w===0&&S(Zo)),h!==r){if(g=p,E=[],C=e.charAt(p),pe.test(C)?p++:(C=r,w===0&&S(ft)),C!==r)for(;C!==r;)E.push(C),C=e.charAt(p),pe.test(C)?p++:(C=r,w===0&&S(ft));else E=r;E!==r?g=e.substring(g,p):g=E,g!==r?c=xi(g):(p=c,c=r)}else p=c,c=r;return w--,c===r&&w===0&&S(Jo),c}function Nt(){var c;return c=qi(),c===r&&(c=Ii()),c}function qi(){var c,h,g,E,C;if(w++,c=p,e.charCodeAt(p)===123?(h=x,p++):(h=r,w===0&&S(ei)),h!==r){for(g=p,E=[],C=e.charAt(p),_r.test(C)?p++:(C=r,w===0&&S(Lr));C!==r;)E.push(C),C=e.charAt(p),_r.test(C)?p++:(C=r,w===0&&S(Lr));g=e.substring(g,p),e.charCodeAt(p)===125?(E=A,p++):(E=r,w===0&&S(ti)),E!==r?c=yi(g):(p=c,c=r)}else p=c,c=r;return w--,c===r&&(h=r,w===0&&S(Xo)),c}function Ii(){var c,h,g,E,C;if(w++,c=p,e.charCodeAt(p)===59?(h=q,p++):(h=r,w===0&&S(ni)),h!==r){for(g=p,E=[],C=e.charAt(p),Sr.test(C)?p++:(C=r,w===0&&S(Tr));C!==r;)E.push(C),C=e.charAt(p),Sr.test(C)?p++:(C=r,w===0&&S(Tr));g=e.substring(g,p),c=wi(g)}else p=c,c=r;return w--,c===r&&(h=r,w===0&&S(ri)),c}function Ur(){var c,h,g,E;return w++,c=p,W(),e.charCodeAt(p)===40?(h=ne,p++):(h=r,w===0&&S(ii)),h!==r?(g=Hr(),g!==r?(W(),e.charCodeAt(p)===41?(E=Z,p++):(E=r,w===0&&S(si)),E!==r?c=ki(g):(p=c,c=r)):(p=c,c=r)):(p=c,c=r),w--,c===r&&w===0&&S(oi),c}function Ni(){var c,h,g;return w++,c=p,e.substr(p,3)===U?(h=U,p+=3):(h=r,w===0&&S(li)),h===r&&(e.substr(p,3)===ye?(h=ye,p+=3):(h=r,w===0&&S(ci)),h===r&&(e.substr(p,7)===I?(h=I,p+=7):(h=r,w===0&&S(di)),h===r&&(e.charCodeAt(p)===42?(h=fe,p++):(h=r,w===0&&S(ui))))),h!==r?(W(),g=Nt(),g===r&&(g=null),c=_i(h,g)):(p=c,c=r),w--,c===r&&(h=r,w===0&&S(ai)),c}function W(){var c,h;for(w++,c=[],h=e.charAt(p),Er.test(h)?p++:(h=r,w===0&&S(qr));h!==r;)c.push(h),h=e.charAt(p),Er.test(h)?p++:(h=r,w===0&&S(qr));return w--,h=r,w===0&&S(fi),c}if(Ye=i(),t.peg$library)return{peg$result:Ye,peg$currPos:p,peg$FAILED:r,peg$maxFailExpected:pt,peg$maxFailPos:oe};if(Ye!==r&&p===e.length)return Ye;throw Ye!==r&&p<e.length&&S(Si()),Ei(pt,oe<e.length?e.charAt(oe):null,oe<e.length?Nr(oe,oe+1):Nr(oe,oe))}var $t=0xffffffffffffffffn;function lr(e,t){return(e<<t|e>>64n-t)&0xffffffffffffffffn}function io(e,t){return e*t&$t}function Ks(e){return function(){let t=BigInt(e&$t),r=BigInt(e>>64n&$t),n=io(lr(io(t,5n),7n),9n);return r^=t,t=(lr(t,24n)^r^r<<16n)&$t,r=lr(r,37n),e=r<<64n|t,n}}var At=Ks(0xa187eb39cdcaed8f31c4b365b102e01en),Hs=Array.from({length:2},()=>Array.from({length:6},()=>Array.from({length:128},()=>At()))),Ds=Array.from({length:8},()=>At()),Rs=Array.from({length:16},()=>At()),cr=At(),Q="w",J="b",O="p",hr="n",Pt="b",ot="r",Me="q",K="k",dr="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",Ue=class{color;from;to;piece;captured;promotion;flags;san;lan;before;after;constructor(t,r){let{color:n,piece:o,from:i,to:s,flags:a,captured:d,promotion:l}=r,u=R(i),f=R(s);this.color=n,this.piece=o,this.from=u,this.to=f,this.san=t._moveToSan(r,t._moves({legal:!0})),this.lan=u+f,this.before=t.fen(),t._makeMove(r),this.after=t.fen(),t._undoMove(),this.flags="";for(let m in P)P[m]&a&&(this.flags+=Ie[m]);d&&(this.captured=d),l&&(this.promotion=l,this.lan+=l)}isCapture(){return this.flags.indexOf(Ie.CAPTURE)>-1}isPromotion(){return this.flags.indexOf(Ie.PROMOTION)>-1}isEnPassant(){return this.flags.indexOf(Ie.EP_CAPTURE)>-1}isKingsideCastle(){return this.flags.indexOf(Ie.KSIDE_CASTLE)>-1}isQueensideCastle(){return this.flags.indexOf(Ie.QSIDE_CASTLE)>-1}isBigPawn(){return this.flags.indexOf(Ie.BIG_PAWN)>-1}},j=-1,Ie={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q",NULL_MOVE:"-"};var P={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64,NULL_MOVE:128},gr={Event:"?",Site:"?",Date:"????.??.??",Round:"?",White:"?",Black:"?",Result:"*"},Us={WhiteTitle:null,BlackTitle:null,WhiteElo:null,BlackElo:null,WhiteUSCF:null,BlackUSCF:null,WhiteNA:null,BlackNA:null,WhiteType:null,BlackType:null,EventDate:null,EventSponsor:null,Section:null,Stage:null,Board:null,Opening:null,Variation:null,SubVariation:null,ECO:null,NIC:null,Time:null,UTCTime:null,UTCDate:null,TimeControl:null,SetUp:null,FEN:null,Termination:null,Annotator:null,Mode:null,PlyCount:null},js={...gr,...Us},$={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},ur={b:[16,32,17,15],w:[-16,-32,-17,-15]},so={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},Bs=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],Fs=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],Qs={p:1,n:2,b:4,r:8,q:16,k:32},Ws="pnbrqkPNBRQK",ao=[hr,Pt,ot,Me],zs=7,Gs=6,Vs=1,Ys=0,Ct={[K]:P.KSIDE_CASTLE,[Me]:P.QSIDE_CASTLE},$e={w:[{square:$.a1,flag:P.QSIDE_CASTLE},{square:$.h1,flag:P.KSIDE_CASTLE}],b:[{square:$.a8,flag:P.QSIDE_CASTLE},{square:$.h8,flag:P.KSIDE_CASTLE}]},Js={b:Vs,w:Gs},fr="--";function Ne(e){return e>>4}function it(e){return e&15}function co(e){return"0123456789".indexOf(e)!==-1}function R(e){let t=it(e),r=Ne(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(r,r+1)}function nt(e){return e===Q?J:Q}function Zs(e){let t=e.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};let r=parseInt(t[5],10);if(isNaN(r)||r<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};let n=parseInt(t[4],10);if(isNaN(n)||n<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};let o=t[0].split("/");if(o.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let s=0;s<o.length;s++){let a=0,d=!1;for(let l=0;l<o[s].length;l++)if(co(o[s][l])){if(d)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};a+=parseInt(o[s][l],10),d=!0}else{if(!/^[prnbqkPRNBQK]$/.test(o[s][l]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};a+=1,d=!1}if(a!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};let i=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(let{color:s,regex:a}of i){if(!a.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${s} king`};if((t[0].match(a)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${s} kings`}}return Array.from(o[0]+o[7]).some(s=>s.toUpperCase()==="P")?{ok:!1,error:"Invalid FEN: some pawns are on the edge rows"}:{ok:!0}}function Xs(e,t){let r=e.from,n=e.to,o=e.piece,i=0,s=0,a=0;for(let d=0,l=t.length;d<l;d++){let u=t[d].from,f=t[d].to,m=t[d].piece;o===m&&r!==u&&n===f&&(i++,Ne(r)===Ne(u)&&s++,it(r)===it(u)&&a++)}return i>0?s>0&&a>0?R(r):a>0?R(r).charAt(1):R(r).charAt(0):""}function Pe(e,t,r,n,o,i=void 0,s=P.NORMAL){let a=Ne(n);if(o===O&&(a===zs||a===Ys))for(let d=0;d<ao.length;d++){let l=ao[d];e.push({color:t,from:r,to:n,piece:o,captured:i,promotion:l,flags:s|P.PROMOTION})}else e.push({color:t,from:r,to:n,piece:o,captured:i,flags:s})}function lo(e){let t=e.charAt(0);return t>="a"&&t<="h"?e.match(/[a-h]\d.*[a-h]\d/)?void 0:O:(t=t.toLowerCase(),t==="o"?K:t)}function pr(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}var Mt=class{_board=new Array(128);_turn=Q;_header={};_kings={w:j,b:j};_epSquare=-1;_halfMoves=0;_moveNumber=0;_history=[];_comments={};_castling={w:0,b:0};_hash=0n;_positionCount=new Map;constructor(t=dr,{skipValidation:r=!1}={}){this.load(t,{skipValidation:r})}clear({preserveHeaders:t=!1}={}){this._board=new Array(128),this._kings={w:j,b:j},this._turn=Q,this._castling={w:0,b:0},this._epSquare=j,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{...js},this._hash=this._computeHash(),this._positionCount=new Map,this._header.SetUp=null,this._header.FEN=null}load(t,{skipValidation:r=!1,preserveHeaders:n=!1}={}){let o=t.split(/\s+/);if(o.length>=2&&o.length<6){let a=["-","-","0","1"];t=o.concat(a.slice(-(6-o.length))).join(" ")}if(o=t.split(/\s+/),!r){let{ok:a,error:d}=Zs(t);if(!a)throw new Error(d)}let i=o[0],s=0;this.clear({preserveHeaders:n});for(let a=0;a<i.length;a++){let d=i.charAt(a);if(d==="/")s+=8;else if(co(d))s+=parseInt(d,10);else{let l=d<"a"?Q:J;this._put({type:d.toLowerCase(),color:l},R(s)),s++}}this._turn=o[1],o[2].indexOf("K")>-1&&(this._castling.w|=P.KSIDE_CASTLE),o[2].indexOf("Q")>-1&&(this._castling.w|=P.QSIDE_CASTLE),o[2].indexOf("k")>-1&&(this._castling.b|=P.KSIDE_CASTLE),o[2].indexOf("q")>-1&&(this._castling.b|=P.QSIDE_CASTLE),this._epSquare=o[3]==="-"?j:$[o[3]],this._halfMoves=parseInt(o[4],10),this._moveNumber=parseInt(o[5],10),this._hash=this._computeHash(),this._updateSetup(t),this._incPositionCount()}fen({forceEnpassantSquare:t=!1}={}){let r=0,n="";for(let s=$.a8;s<=$.h1;s++){if(this._board[s]){r>0&&(n+=r,r=0);let{color:a,type:d}=this._board[s];n+=a===Q?d.toUpperCase():d.toLowerCase()}else r++;s+1&136&&(r>0&&(n+=r),s!==$.h1&&(n+="/"),r=0,s+=8)}let o="";this._castling[Q]&P.KSIDE_CASTLE&&(o+="K"),this._castling[Q]&P.QSIDE_CASTLE&&(o+="Q"),this._castling[J]&P.KSIDE_CASTLE&&(o+="k"),this._castling[J]&P.QSIDE_CASTLE&&(o+="q"),o=o||"-";let i="-";if(this._epSquare!==j)if(t)i=R(this._epSquare);else{let s=this._epSquare+(this._turn===Q?16:-16),a=[s+1,s-1];for(let d of a){if(d&136)continue;let l=this._turn;if(this._board[d]?.color===l&&this._board[d]?.type===O){this._makeMove({color:l,from:d,to:this._epSquare,piece:O,captured:O,flags:P.EP_CAPTURE});let u=!this._isKingAttacked(l);if(this._undoMove(),u){i=R(this._epSquare);break}}}}return[n,this._turn,o,i,this._halfMoves,this._moveNumber].join(" ")}_pieceKey(t){if(!this._board[t])return 0n;let{color:r,type:n}=this._board[t],o={w:0,b:1}[r],i={p:0,n:1,b:2,r:3,q:4,k:5}[n];return Hs[o][i][t]}_epKey(){return this._epSquare===j?0n:Ds[this._epSquare&7]}_castlingKey(){let t=this._castling.w>>5|this._castling.b>>3;return Rs[t]}_computeHash(){let t=0n;for(let r=$.a8;r<=$.h1;r++){if(r&136){r+=7;continue}this._board[r]&&(t^=this._pieceKey(r))}return t^=this._epKey(),t^=this._castlingKey(),this._turn==="b"&&(t^=cr),t}_updateSetup(t){this._history.length>0||(t!==dr?(this._header.SetUp="1",this._header.FEN=t):(this._header.SetUp=null,this._header.FEN=null))}reset(){this.load(dr)}get(t){return this._board[$[t]]}findPiece(t){let r=[];for(let n=$.a8;n<=$.h1;n++){if(n&136){n+=7;continue}!this._board[n]||this._board[n]?.color!==t.color||this._board[n].color===t.color&&this._board[n].type===t.type&&r.push(R(n))}return r}put({type:t,color:r},n){return this._put({type:t,color:r},n)?(this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0):!1}_set(t,r){this._hash^=this._pieceKey(t),this._board[t]=r,this._hash^=this._pieceKey(t)}_put({type:t,color:r},n){if(Ws.indexOf(t.toLowerCase())===-1||!(n in $))return!1;let o=$[n];if(t==K&&!(this._kings[r]==j||this._kings[r]==o))return!1;let i=this._board[o];return i&&i.type===K&&(this._kings[i.color]=j),this._set(o,{type:t,color:r}),t===K&&(this._kings[r]=o),!0}_clear(t){this._hash^=this._pieceKey(t),delete this._board[t]}remove(t){let r=this.get(t);return this._clear($[t]),r&&r.type===K&&(this._kings[r.color]=j),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),r}_updateCastlingRights(){this._hash^=this._castlingKey();let t=this._board[$.e1]?.type===K&&this._board[$.e1]?.color===Q,r=this._board[$.e8]?.type===K&&this._board[$.e8]?.color===J;(!t||this._board[$.a1]?.type!==ot||this._board[$.a1]?.color!==Q)&&(this._castling.w&=-65),(!t||this._board[$.h1]?.type!==ot||this._board[$.h1]?.color!==Q)&&(this._castling.w&=-33),(!r||this._board[$.a8]?.type!==ot||this._board[$.a8]?.color!==J)&&(this._castling.b&=-65),(!r||this._board[$.h8]?.type!==ot||this._board[$.h8]?.color!==J)&&(this._castling.b&=-33),this._hash^=this._castlingKey()}_updateEnPassantSquare(){if(this._epSquare===j)return;let t=this._epSquare+(this._turn===Q?-16:16),r=this._epSquare+(this._turn===Q?16:-16),n=[r+1,r-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||this._board[r]?.color!==nt(this._turn)||this._board[r]?.type!==O){this._hash^=this._epKey(),this._epSquare=j;return}let o=i=>!(i&136)&&this._board[i]?.color===this._turn&&this._board[i]?.type===O;n.some(o)||(this._hash^=this._epKey(),this._epSquare=j)}_attacked(t,r,n){let o=[];for(let i=$.a8;i<=$.h1;i++){if(i&136){i+=7;continue}if(this._board[i]===void 0||this._board[i].color!==t)continue;let s=this._board[i],a=i-r;if(a===0)continue;let d=a+119;if(Bs[d]&Qs[s.type]){if(s.type===O){if(a>0&&s.color===Q||a<=0&&s.color===J)if(n)o.push(R(i));else return!0;continue}if(s.type==="n"||s.type==="k")if(n){o.push(R(i));continue}else return!0;let l=Fs[d],u=i+l,f=!1;for(;u!==r;){if(this._board[u]!=null){f=!0;break}u+=l}if(!f)if(n){o.push(R(i));continue}else return!0}}return n?o:!1}attackers(t,r){return r?this._attacked(r,$[t],!0):this._attacked(this._turn,$[t],!0)}_isKingAttacked(t){let r=this._kings[t];return r===-1?!1:this._attacked(nt(t),r)}hash(){return this._hash.toString(16)}isAttacked(t,r){return this._attacked(r,$[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){let t={b:0,n:0,r:0,q:0,k:0,p:0},r=[],n=0,o=0;for(let i=$.a8;i<=$.h1;i++){if(o=(o+1)%2,i&136){i+=7;continue}let s=this._board[i];s&&(t[s.type]=s.type in t?t[s.type]+1:1,s.type===Pt&&r.push(o),n++)}if(n===2)return!0;if(n===3&&(t[Pt]===1||t[hr]===1))return!0;if(n===t[Pt]+2){let i=0,s=r.length;for(let a=0;a<s;a++)i+=r[a];if(i===0||i===s)return!0}return!1}isThreefoldRepetition(){return this._getPositionCount(this._hash)>=3}isDrawByFiftyMoves(){return this._halfMoves>=100}isDraw(){return this.isDrawByFiftyMoves()||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isDraw()}moves({verbose:t=!1,square:r=void 0,piece:n=void 0}={}){let o=this._moves({square:r,piece:n});return t?o.map(i=>new Ue(this,i)):o.map(i=>this._moveToSan(i,o))}_moves({legal:t=!0,piece:r=void 0,square:n=void 0}={}){let o=n?n.toLowerCase():void 0,i=r?.toLowerCase(),s=[],a=this._turn,d=nt(a),l=$.a8,u=$.h1,f=!1;if(o)if(o in $)l=u=$[o],f=!0;else return[];for(let v=l;v<=u;v++){if(v&136){v+=7;continue}if(!this._board[v]||this._board[v].color===d)continue;let{type:b}=this._board[v],x;if(b===O){if(i&&i!==b)continue;x=v+ur[a][0],this._board[x]||(Pe(s,a,v,x,O),x=v+ur[a][1],Js[a]===Ne(v)&&!this._board[x]&&Pe(s,a,v,x,O,void 0,P.BIG_PAWN));for(let A=2;A<4;A++)x=v+ur[a][A],!(x&136)&&(this._board[x]?.color===d?Pe(s,a,v,x,O,this._board[x].type,P.CAPTURE):x===this._epSquare&&Pe(s,a,v,x,O,O,P.EP_CAPTURE))}else{if(i&&i!==b)continue;for(let A=0,q=so[b].length;A<q;A++){let ne=so[b][A];for(x=v;x+=ne,!(x&136);){if(!this._board[x])Pe(s,a,v,x,b);else{if(this._board[x].color===a)break;Pe(s,a,v,x,b,this._board[x].type,P.CAPTURE);break}if(b===hr||b===K)break}}}}if((i===void 0||i===K)&&(!f||u===this._kings[a])){if(this._castling[a]&P.KSIDE_CASTLE){let v=this._kings[a],b=v+2;!this._board[v+1]&&!this._board[b]&&!this._attacked(d,this._kings[a])&&!this._attacked(d,v+1)&&!this._attacked(d,b)&&Pe(s,a,this._kings[a],b,K,void 0,P.KSIDE_CASTLE)}if(this._castling[a]&P.QSIDE_CASTLE){let v=this._kings[a],b=v-2;!this._board[v-1]&&!this._board[v-2]&&!this._board[v-3]&&!this._attacked(d,this._kings[a])&&!this._attacked(d,v-1)&&!this._attacked(d,b)&&Pe(s,a,this._kings[a],b,K,void 0,P.QSIDE_CASTLE)}}if(!t||this._kings[a]===-1)return s;let m=[];for(let v=0,b=s.length;v<b;v++)this._makeMove(s[v]),this._isKingAttacked(a)||m.push(s[v]),this._undoMove();return m}move(t,{strict:r=!1}={}){let n=null;if(typeof t=="string")n=this._moveFromSan(t,r);else if(t===null)n=this._moveFromSan(fr,r);else if(typeof t=="object"){let i=this._moves();for(let s=0,a=i.length;s<a;s++)if(t.from===R(i[s].from)&&t.to===R(i[s].to)&&(!("promotion"in i[s])||t.promotion===i[s].promotion)){n=i[s];break}}if(!n)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);if(this.isCheck()&&n.flags&P.NULL_MOVE)throw new Error("Null move not allowed when in check");let o=new Ue(this,n);return this._makeMove(n),this._incPositionCount(),o}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_movePiece(t,r){this._hash^=this._pieceKey(t),this._board[r]=this._board[t],delete this._board[t],this._hash^=this._pieceKey(r)}_makeMove(t){let r=this._turn,n=nt(r);if(this._push(t),t.flags&P.NULL_MOVE){r===J&&this._moveNumber++,this._halfMoves++,this._turn=n,this._epSquare=j;return}if(this._hash^=this._epKey(),this._hash^=this._castlingKey(),t.captured&&(this._hash^=this._pieceKey(t.to)),this._movePiece(t.from,t.to),t.flags&P.EP_CAPTURE&&(this._turn===J?this._clear(t.to-16):this._clear(t.to+16)),t.promotion&&(this._clear(t.to),this._set(t.to,{type:t.promotion,color:r})),this._board[t.to].type===K){if(this._kings[r]=t.to,t.flags&P.KSIDE_CASTLE){let o=t.to-1,i=t.to+1;this._movePiece(i,o)}else if(t.flags&P.QSIDE_CASTLE){let o=t.to+1,i=t.to-2;this._movePiece(i,o)}this._castling[r]=0}if(this._castling[r]){for(let o=0,i=$e[r].length;o<i;o++)if(t.from===$e[r][o].square&&this._castling[r]&$e[r][o].flag){this._castling[r]^=$e[r][o].flag;break}}if(this._castling[n]){for(let o=0,i=$e[n].length;o<i;o++)if(t.to===$e[n][o].square&&this._castling[n]&$e[n][o].flag){this._castling[n]^=$e[n][o].flag;break}}if(this._hash^=this._castlingKey(),t.flags&P.BIG_PAWN){let o;r===J?o=t.to-16:o=t.to+16,!(t.to-1&136)&&this._board[t.to-1]?.type===O&&this._board[t.to-1]?.color===n||!(t.to+1&136)&&this._board[t.to+1]?.type===O&&this._board[t.to+1]?.color===n?(this._epSquare=o,this._hash^=this._epKey()):this._epSquare=j}else this._epSquare=j;t.piece===O?this._halfMoves=0:t.flags&(P.CAPTURE|P.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,r===J&&this._moveNumber++,this._turn=n,this._hash^=cr}undo(){let t=this._hash,r=this._undoMove();if(r){let n=new Ue(this,r);return this._decPositionCount(t),n}return null}_undoMove(){let t=this._history.pop();if(t===void 0)return null;this._hash^=this._epKey(),this._hash^=this._castlingKey();let r=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber,this._hash^=this._epKey(),this._hash^=this._castlingKey(),this._hash^=cr;let n=this._turn,o=nt(n);if(r.flags&P.NULL_MOVE)return r;if(this._movePiece(r.to,r.from),r.piece&&(this._clear(r.from),this._set(r.from,{type:r.piece,color:n})),r.captured)if(r.flags&P.EP_CAPTURE){let i;n===J?i=r.to-16:i=r.to+16,this._set(i,{type:O,color:o})}else this._set(r.to,{type:r.captured,color:o});if(r.flags&(P.KSIDE_CASTLE|P.QSIDE_CASTLE)){let i,s;r.flags&P.KSIDE_CASTLE?(i=r.to+1,s=r.to-1):(i=r.to-2,s=r.to+1),this._movePiece(s,i)}return r}pgn({newline:t=`
`,maxWidth:r=0}={}){let n=[],o=!1;for(let m in this._header)this._header[m]&&n.push(`[${m} "${this._header[m]}"]`+t),o=!0;o&&this._history.length&&n.push(t);let i=m=>{let v=this._comments[this.fen()];if(typeof v<"u"){let b=m.length>0?" ":"";m=`${m}${b}{${v}}`}return m},s=[];for(;this._history.length>0;)s.push(this._undoMove());let a=[],d="";for(s.length===0&&a.push(i(""));s.length>0;){d=i(d);let m=s.pop();if(!m)break;if(!this._history.length&&m.color==="b"){let v=`${this._moveNumber}. ...`;d=d?`${d} ${v}`:v}else m.color==="w"&&(d.length&&a.push(d),d=this._moveNumber+".");d=d+" "+this._moveToSan(m,this._moves({legal:!0})),this._makeMove(m)}if(d.length&&a.push(i(d)),a.push(this._header.Result||"*"),r===0)return n.join("")+a.join(" ");let l=function(){return n.length>0&&n[n.length-1]===" "?(n.pop(),!0):!1},u=function(m,v){for(let b of v.split(" "))if(b){if(m+b.length>r){for(;l();)m--;n.push(t),m=0}n.push(b),m+=b.length,n.push(" "),m++}return l()&&m--,m},f=0;for(let m=0;m<a.length;m++){if(f+a[m].length>r&&a[m].includes("{")){f=u(f,a[m]);continue}f+a[m].length>r&&m!==0?(n[n.length-1]===" "&&n.pop(),n.push(t),f=0):m!==0&&(n.push(" "),f++),n.push(a[m]),f+=a[m].length}return n.join("")}header(...t){for(let r=0;r<t.length;r+=2)typeof t[r]=="string"&&typeof t[r+1]=="string"&&(this._header[t[r]]=t[r+1]);return this._header}setHeader(t,r){return this._header[t]=r??gr[t]??null,this.getHeaders()}removeHeader(t){return t in this._header?(this._header[t]=gr[t]||null,!0):!1}getHeaders(){let t={};for(let[r,n]of Object.entries(this._header))n!==null&&(t[r]=n);return t}loadPgn(t,{strict:r=!1,newlineChar:n=`\r?
`}={}){n!==`\r?
`&&(t=t.replace(new RegExp(n,"g"),`
`));let o=Os(t);this.reset();let i=o.headers,s="";for(let l in i)l.toLowerCase()==="fen"&&(s=i[l]),this.header(l,i[l]);if(!r)s&&this.load(s,{preserveHeaders:!0});else if(i.SetUp==="1"){if(!("FEN"in i))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(i.FEN,{preserveHeaders:!0})}let a=o.root;for(;a;){if(a.move){let l=this._moveFromSan(a.move,r);if(l==null)throw new Error(`Invalid move in PGN: ${a.move}`);this._makeMove(l),this._incPositionCount()}a.comment!==void 0&&(this._comments[this.fen()]=a.comment),a=a.variations[0]}let d=o.result;d&&Object.keys(this._header).length&&this._header.Result!==d&&this.setHeader("Result",d)}_moveToSan(t,r){let n="";if(t.flags&P.KSIDE_CASTLE)n="O-O";else if(t.flags&P.QSIDE_CASTLE)n="O-O-O";else{if(t.flags&P.NULL_MOVE)return fr;if(t.piece!==O){let o=Xs(t,r);n+=t.piece.toUpperCase()+o}t.flags&(P.CAPTURE|P.EP_CAPTURE)&&(t.piece===O&&(n+=R(t.from)[0]),n+="x"),n+=R(t.to),t.promotion&&(n+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?n+="#":n+="+"),this._undoMove(),n}_moveFromSan(t,r=!1){let n=pr(t);if(r||(n==="0-0"?n="O-O":n==="0-0-0"&&(n="O-O-O")),n==fr)return{color:this._turn,from:0,to:0,piece:"k",flags:P.NULL_MOVE};let o=lo(n),i=this._moves({legal:!0,piece:o});for(let m=0,v=i.length;m<v;m++)if(n===pr(this._moveToSan(i[m],i)))return i[m];if(r)return null;let s,a,d,l,u,f=!1;if(a=n.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),a?(s=a[1],d=a[2],l=a[3],u=a[4],d.length==1&&(f=!0)):(a=n.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),a&&(s=a[1],d=a[2],l=a[3],u=a[4],d.length==1&&(f=!0))),o=lo(n),i=this._moves({legal:!0,piece:s||o}),!l)return null;for(let m=0,v=i.length;m<v;m++)if(d){if((!s||s.toLowerCase()==i[m].piece)&&$[d]==i[m].from&&$[l]==i[m].to&&(!u||u.toLowerCase()==i[m].promotion))return i[m];if(f){let b=R(i[m].from);if((!s||s.toLowerCase()==i[m].piece)&&$[l]==i[m].to&&(d==b[0]||d==b[1])&&(!u||u.toLowerCase()==i[m].promotion))return i[m]}}else if(n===pr(this._moveToSan(i[m],i)).replace("x",""))return i[m];return null}ascii(){let t=`   +------------------------+
`;for(let r=$.a8;r<=$.h1;r++){if(it(r)===0&&(t+=" "+"87654321"[Ne(r)]+" |"),this._board[r]){let n=this._board[r].type,i=this._board[r].color===Q?n.toUpperCase():n.toLowerCase();t+=" "+i+" "}else t+=" . ";r+1&136&&(t+=`|
`,r+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){let r=this._moves({legal:!1}),n=0,o=this._turn;for(let i=0,s=r.length;i<s;i++)this._makeMove(r[i]),this._isKingAttacked(o)||(t-1>0?n+=this.perft(t-1):n++),this._undoMove();return n}setTurn(t){return this._turn==t?!1:(this.move("--"),!0)}turn(){return this._turn}board(){let t=[],r=[];for(let n=$.a8;n<=$.h1;n++)this._board[n]==null?r.push(null):r.push({square:R(n),type:this._board[n].type,color:this._board[n].color}),n+1&136&&(t.push(r),r=[],n+=8);return t}squareColor(t){if(t in $){let r=$[t];return(Ne(r)+it(r))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){let r=[],n=[];for(;this._history.length>0;)r.push(this._undoMove());for(;;){let o=r.pop();if(!o)break;t?n.push(new Ue(this,o)):n.push(this._moveToSan(o,this._moves())),this._makeMove(o)}return n}_getPositionCount(t){return this._positionCount.get(t)??0}_incPositionCount(){this._positionCount.set(this._hash,(this._positionCount.get(this._hash)??0)+1)}_decPositionCount(t){let r=this._positionCount.get(t)??0;r===1?this._positionCount.delete(t):this._positionCount.set(t,r-1)}_pruneComments(){let t=[],r={},n=o=>{o in this._comments&&(r[o]=this._comments[o])};for(;this._history.length>0;)t.push(this._undoMove());for(n(this.fen());;){let o=t.pop();if(!o)break;this._makeMove(o),n(this.fen())}this._comments=r}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){return this.removeComment()}removeComment(){let t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this.removeComments()}removeComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{let r=this._comments[t];return delete this._comments[t],{fen:t,comment:r}})}setCastlingRights(t,r){for(let o of[K,Me])r[o]!==void 0&&(r[o]?this._castling[t]|=Ct[o]:this._castling[t]&=~Ct[o]);this._updateCastlingRights();let n=this.getCastlingRights(t);return(r[K]===void 0||r[K]===n[K])&&(r[Me]===void 0||r[Me]===n[Me])}getCastlingRights(t){return{[K]:(this._castling[t]&Ct[K])!==0,[Me]:(this._castling[t]&Ct[Me])!==0}}moveNumber(){return this._moveNumber}};var uo="clu_packs",fo="clu_character_sets",mr="clu_saves";function st(){try{let e=JSON.parse(localStorage.getItem(uo)??"[]");return Array.isArray(e)?e.filter(t=>t&&typeof t.title=="string"&&Array.isArray(t.questions)&&typeof t.starsPerCorrect=="number"):[]}catch{return[]}}function Be(e){localStorage.setItem(uo,JSON.stringify(e))}function at(){try{let e=JSON.parse(localStorage.getItem(fo)??"[]");return Array.isArray(e)?e.filter(t=>t&&typeof t.title=="string"&&Array.isArray(t.characters)):[]}catch{return[]}}function Fe(e){localStorage.setItem(fo,JSON.stringify(e))}function xe(){try{let e=JSON.parse(localStorage.getItem(mr)??"[]");return Array.isArray(e)?e.filter(t=>t&&typeof t.id=="string"&&typeof t.playerName=="string"&&t.state!=null):[]}catch{return[]}}function Lt(e){let t=xe(),r=t.findIndex(i=>i.id===e.id),n=e.unlockedUpTo>=0?e.characterSet.characters[e.unlockedUpTo]?.name??"":"",o={id:e.id,playerName:e.playerName,packTitle:e.pack.title,charName:n,questionProgress:`${e.currentIndex+1} / ${e.shuffledQuestions.length}`,totalStars:e.totalStars,savedAt:Date.now(),state:e};r>=0?t[r]=o:t.unshift(o),localStorage.setItem(mr,JSON.stringify(t))}function lt(e){let t=xe().filter(r=>r.id!==e);localStorage.setItem(mr,JSON.stringify(t))}async function po(){try{let t=await(await fetch("packs/index.json")).json();return Promise.all(t.map(r=>fetch(`packs/${r}`).then(n=>n.json())))}catch{return[]}}async function ho(){try{let t=await(await fetch("characters/index.json")).json();return Promise.all(t.map(r=>fetch(`characters/${r}`).then(n=>n.json())))}catch{return[]}}var _=null,dt=null,Oe=0,Ae=()=>{},ct=null,re=0,ue=null,le=null,bo=[],xo=[];function yo(e){Ae=e}async function wo(){[bo,xo]=await Promise.all([po(),ho()])}function ko(){return xe().length>0}function ea(){return[...bo,...st()]}function ta(){return[...xo,...at()]}function _o(e){let t=ea(),r=ta(),n=t.length>0&&r.length>0;if(e.innerHTML=`
    <div class="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-950">
      <h1 class="text-3xl font-bold mb-8">\u041D\u043E\u0432\u0430\u044F \u0438\u0433\u0440\u0430</h1>

      <div class="w-full max-w-md space-y-5">

        <div>
          <label class="block text-xs text-gray-400 uppercase tracking-wider mb-1.5">\u0418\u043C\u044F \u0438\u0433\u0440\u043E\u043A\u0430</label>
          <input id="inp-name" type="text" maxlength="40" placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0438\u043C\u044F..."
            class="w-full bg-gray-800 text-white rounded-xl px-4 py-3 border border-gray-700 focus:outline-none focus:border-indigo-500" />
        </div>

        <div>
          <label class="block text-xs text-gray-400 uppercase tracking-wider mb-1.5">\u041F\u0430\u043A\u0435\u0442 \u0432\u043E\u043F\u0440\u043E\u0441\u043E\u0432</label>
          ${t.length>0?`<select id="sel-pack" class="w-full bg-gray-800 text-white rounded-xl px-4 py-3 border border-gray-700 focus:outline-none focus:border-indigo-500">
                ${t.map((o,i)=>`<option value="${i}">${M(o.title)} (${o.questions.length} \u0432\u043E\u043F\u0440. \xB7 ${o.starsPerCorrect}\u2605)</option>`).join("")}
               </select>`:'<div class="bg-gray-800 text-red-400 rounded-xl px-4 py-3 text-sm">\u041D\u0435\u0442 \u043F\u0430\u043A\u0435\u0442\u043E\u0432. \u0421\u043E\u0437\u0434\u0430\u0439\u0442\u0435 \u0432 \xAB\u0420\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u0435 \u0432\u043E\u043F\u0440\u043E\u0441\u043E\u0432\xBB.</div>'}
        </div>

        <div>
          <label class="block text-xs text-gray-400 uppercase tracking-wider mb-1.5">\u041D\u0430\u0431\u043E\u0440 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0435\u0439</label>
          ${r.length>0?`<select id="sel-chars" class="w-full bg-gray-800 text-white rounded-xl px-4 py-3 border border-gray-700 focus:outline-none focus:border-indigo-500">
                ${r.map((o,i)=>`<option value="${i}">${M(o.title)} (${o.characters.length} \u043F\u0435\u0440\u0441.)</option>`).join("")}
               </select>`:'<div class="bg-gray-800 text-red-400 rounded-xl px-4 py-3 text-sm">\u041D\u0435\u0442 \u043D\u0430\u0431\u043E\u0440\u043E\u0432. \u0421\u043E\u0437\u0434\u0430\u0439\u0442\u0435 \u0432 \xAB\u0420\u0435\u0434\u0430\u043A\u0442\u043E\u0440\u0435 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0435\u0439\xBB.</div>'}
          <div id="compat-warning"></div>
        </div>

        <div>
          <label class="block text-xs text-gray-400 uppercase tracking-wider mb-1.5">\u0422\u0430\u0439\u043C\u0435\u0440 \u043D\u0430 \u0432\u043E\u043F\u0440\u043E\u0441 (\u0441\u0435\u043A, 0 = \u0431\u0435\u0437 \u0442\u0430\u0439\u043C\u0435\u0440\u0430)</label>
          <input id="inp-timer" type="number" min="0" max="300" value="0"
            class="w-full bg-gray-800 text-white rounded-xl px-4 py-3 border border-gray-700 focus:outline-none focus:border-indigo-500" />
        </div>

        <button id="btn-start"
          class="w-full py-4 rounded-xl font-bold text-lg transition
            ${n?"bg-indigo-600 hover:bg-indigo-500 text-white":"bg-gray-700 text-gray-500 cursor-not-allowed"}"
          ${n?"":"disabled"}>
          \u041D\u0430\u0447\u0430\u0442\u044C \u0438\u0433\u0440\u0443
        </button>

        <button id="btn-back"
          class="w-full py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-xl font-semibold transition">
          \u041D\u0430\u0437\u0430\u0434
        </button>

      </div>
    </div>
  `,n){let o=e.querySelector("#sel-pack"),i=e.querySelector("#sel-chars"),s=()=>{let a=t[parseInt(o.value)],d=r[parseInt(i.value)],l=e.querySelector("#compat-warning");if(!a||!d){l.innerHTML="";return}let u=a.questions.length*a.starsPerCorrect,f=[...d.characters].sort((x,A)=>x.cost-A.cost),m=f[f.length-1]?.cost??0,v=f.filter(x=>x.cost<=u).length,b=e.querySelector("#btn-start");v===0?(l.innerHTML=`<div class="mt-2 px-3 py-2 bg-red-950 border border-red-800 rounded-xl text-red-300 text-xs">
          \u26D4 \u041D\u0435\u043B\u044C\u0437\u044F \u043E\u0442\u043A\u0440\u044B\u0442\u044C \u043D\u0438 \u043E\u0434\u043D\u043E\u0433\u043E \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0430 \u2014 \u043C\u0430\u043A\u0441. ${u}\u2605, \u0430 \u0441\u0430\u043C\u044B\u0439 \u0434\u0435\u0448\u0451\u0432\u044B\u0439 \u0441\u0442\u043E\u0438\u0442 ${f[0]?.cost??0}\u2605
        </div>`,b.disabled=!0,b.classList.add("opacity-50","cursor-not-allowed")):u<m?(l.innerHTML=`<div class="mt-2 px-3 py-2 bg-yellow-950 border border-yellow-800 rounded-xl text-yellow-300 text-xs">
          \u26A0 \u041C\u043E\u0436\u043D\u043E \u043E\u0442\u043A\u0440\u044B\u0442\u044C ${v} \u0438\u0437 ${f.length} \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0435\u0439 (\u043C\u0430\u043A\u0441. ${u}\u2605, \u043D\u0443\u0436\u043D\u043E ${m}\u2605)
        </div>`,b.disabled=!1,b.classList.remove("opacity-50","cursor-not-allowed")):(l.innerHTML=`<div class="mt-2 px-3 py-2 bg-green-950 border border-green-800 rounded-xl text-green-400 text-xs">
          \u2713 \u0412\u0441\u0435 ${f.length} ${ra(f.length,"\u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436","\u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0430","\u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0435\u0439")} \u043E\u0442\u043A\u0440\u044B\u0432\u0430\u0435\u043C\u044B (\u043C\u0430\u043A\u0441. ${u}\u2605 \u043F\u0440\u0438 \u043D\u0443\u0436\u043D\u044B\u0445 ${m}\u2605)
        </div>`,b.disabled=!1,b.classList.remove("opacity-50","cursor-not-allowed"))};o.addEventListener("change",s),i.addEventListener("change",s),s(),e.querySelector("#btn-start")?.addEventListener("click",()=>{let a=e.querySelector("#inp-name").value.trim().slice(0,40),d=parseInt(o.value),l=parseInt(i.value),u=Math.max(0,parseInt(e.querySelector("#inp-timer").value)||0);oa(t[d],r[l],u,a)})}e.querySelector("#btn-back")?.addEventListener("click",()=>Ae("home"))}function ra(e,t,r,n){let o=e%100;if(o>=11&&o<=14)return n;switch(e%10){case 1:return t;case 2:case 3:case 4:return r;default:return n}}function na(e){let t=[...e];for(let r=t.length-1;r>0;r--){let n=Math.floor(Math.random()*(r+1));[t[r],t[n]]=[t[n],t[r]]}return t}function oa(e,t,r,n){let o=[...t.characters].sort((f,m)=>f.cost-m.cost),i=na(e.questions),s=o.at(-1)?.cost??0,a=Math.ceil(s/e.starsPerCorrect),d=e.questions.length>o.length,l=d?i.slice(0,a):i,u=d?i.slice(a):[];_={id:Date.now().toString(36)+Math.random().toString(36).slice(2,6),playerName:n,pack:e,characterSet:{...t,characters:o},shuffledQuestions:l,spareQuestions:u,currentIndex:0,totalStars:0,timerSeconds:r,unlockedUpTo:-1},Lt(_),Ae("game"),vr()}function So(e){let t=xe().find(r=>r.id===e);t&&(_=t.state,_.spareQuestions??=[],Ae("game"),vr())}function vr(){if(!_)return;Ke(),ct=null,re=0,ue=null,le&&(document.removeEventListener("keydown",le),le=null);let e=document.getElementById("screen-game"),t=_.characterSet.characters,r=_.unlockedUpTo>=0?t[_.unlockedUpTo]??null:null,n=t[_.unlockedUpTo+1]??null,o=_.shuffledQuestions[_.currentIndex],i=(x,A="")=>{let q=x?we(x):"";return q?`<img src="${q}" alt="" class="${A}" />`:null},s=(x,A=!1)=>{if(!x)return'<span class="text-5xl opacity-30">\u{1F512}</span>';let q=x.imageUrl?we(x.imageUrl):"";return q?`<img src="${q}" alt="" class="w-full h-full object-contain${A?" grayscale":""}" />`:'<span class="text-5xl">\u{1F464}</span>'},a=(x,A=!1)=>x?`<div class="text-xs font-semibold text-center truncate w-full${A?" text-gray-400":""}">${M(x.name)}</div>
         <div class="text-yellow-400 text-xs${A?" opacity-60":""}">\u2605 ${x.cost}</div>`:'<div class="text-xs text-gray-600 text-center">\u2014</div>',d=x=>x?"w-[160px] h-[160px] rounded-xl overflow-hidden bg-gray-800 flex items-center justify-center flex-shrink-0":"w-[160px] h-[160px] rounded-xl border-2 border-dashed border-gray-700 flex items-center justify-center flex-shrink-0",l=x=>`
    <button id="btn-all-chars"
      class="w-full ${x} bg-gray-800 hover:bg-gray-700 text-white rounded-xl font-semibold transition border border-gray-700 hover:border-gray-500 flex items-center justify-center gap-2 text-sm">
      <span>\u{1F3C5}</span> \u0412\u0441\u0435 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0438
    </button>
    <div class="flex gap-2">
      <div class="relative flex-1 ${x} rounded-xl overflow-hidden bg-gray-800 border border-gray-700">
        <div class="absolute inset-0 bg-gradient-to-r from-indigo-600 to-violet-600 transition-all duration-500"
             style="width:${Math.round((_.currentIndex+1)/_.shuffledQuestions.length*100)}%"></div>
        <span class="absolute inset-0 flex items-center justify-center text-sm font-semibold text-white drop-shadow">
          ${_.currentIndex+1} / ${_.shuffledQuestions.length}
        </span>
      </div>
      <button id="btn-exit"
        class="${x} px-4 bg-gray-800 hover:bg-red-950 text-gray-300 hover:text-red-300 rounded-xl font-semibold text-sm transition border border-gray-700 hover:border-red-800 flex-shrink-0">
        \u0412\u044B\u0445\u043E\u0434
      </button>
    </div>`;if(o.fen?e.innerHTML=`
      <div class="h-screen flex items-center justify-center bg-gray-950 overflow-hidden"
           style="--sz:min(calc(100vh - 24px),calc(100vw - 400px),780px)">
        <div class="flex gap-4">

          <!-- Board -->
          <div id="board-container"
               class="rounded-xl shadow-2xl overflow-hidden flex-shrink-0"
               style="width:var(--sz);height:var(--sz)">
          </div>

          <!-- Panel: same height as board -->
          <div class="w-[360px] flex-shrink-0 bg-gray-900 rounded-xl border border-gray-800 flex flex-col overflow-hidden"
               style="height:var(--sz)">

            <!-- Question text -->
            <div class="px-4 py-4 border-b border-gray-800 flex-shrink-0">
              <div class="text-lg font-semibold text-center leading-snug">
                ${M(o.text)}
              </div>
            </div>

            <!-- Characters: column -->
            <div class="flex-1 min-h-0 flex flex-col items-center justify-evenly px-6 py-2 overflow-hidden">
              <div class="flex flex-col items-center gap-1 w-full">
                <div class="${d(r)}">
                  ${s(r)}
                </div>
                ${a(r)}
              </div>
              <div class="text-gray-600 text-base">\u2193</div>
              <div class="flex flex-col items-center gap-1 w-full">
                <div class="${d(n)}">
                  ${n?s(n,!0):'<span class="text-3xl">\u{1F3C6}</span>'}
                </div>
                ${n?a(n,!0):'<div class="text-xs text-gray-500 text-center">\u0424\u0438\u043D\u0430\u043B!</div>'}
              </div>
            </div>

            <!-- Bottom: controls + nav -->
            <div class="px-4 py-3 border-t border-gray-800 flex-shrink-0 space-y-2 relative">
              <div id="nav-lock-indicator" class="hidden absolute -top-5 left-0 right-0 text-xs text-yellow-500 text-center">\u{1F512} \u0417\u0430\u0431\u043B\u043E\u043A\u0438\u0440\u043E\u0432\u0430\u043D\u043E</div>
              <div class="flex items-center gap-1.5">
                ${o.solutionMovesUci&&o.solutionMovesUci.length>0?`
                <button id="btn-nav-prev" class="flex-1 h-12 bg-gray-800 hover:bg-gray-700 text-white rounded-xl text-2xl transition flex items-center justify-center disabled:opacity-30">\u2039</button>
                <button id="btn-nav-next" class="flex-1 h-12 bg-gray-800 hover:bg-gray-700 text-white rounded-xl text-2xl transition flex items-center justify-center disabled:opacity-30">\u203A</button>
                `:""}
                <button id="btn-correct" class="flex-1 h-12 bg-gray-800 hover:bg-gray-700 text-green-400 rounded-xl text-2xl transition flex items-center justify-center disabled:opacity-30">\u2714</button>
                <button id="btn-wrong"   class="flex-1 h-12 bg-gray-800 hover:bg-gray-700 text-red-400   rounded-xl text-2xl transition flex items-center justify-center disabled:opacity-30">\u2715</button>
                ${_.timerSeconds>0?`
                <div id="timer-display" class="flex-[1.5] h-12 flex items-center justify-center text-2xl font-black text-white bg-gray-800 rounded-xl">${_.timerSeconds}</div>
                `:""}
              </div>
              ${l("h-10")}
            </div>

          </div>
        </div>
      </div>`:e.innerHTML=`
      <div class="h-screen flex flex-col bg-gray-950">
        <div class="flex flex-1 min-h-0">

          <!-- Center: question -->
          <div class="flex-1 flex flex-col items-center justify-center gap-5 p-8 overflow-y-auto">
            ${_.timerSeconds>0?`<div id="timer-display" class="text-6xl font-black text-white leading-none">${_.timerSeconds}</div>`:""}
            ${i(o.imageUrl,"max-h-[65vh] max-w-full w-full object-contain rounded-2xl")??""}
            <div class="text-2xl font-semibold text-center max-w-2xl leading-relaxed">
              ${M(o.text)}
            </div>
            <button id="btn-show-answer"
              class="py-3 px-10 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-lg transition">
              \u041F\u043E\u043A\u0430\u0437\u0430\u0442\u044C \u043E\u0442\u0432\u0435\u0442
            </button>
            <div id="answer-block" class="hidden w-full max-w-xl flex flex-col gap-4">
              <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 text-center">
                <div class="text-xs text-gray-400 uppercase tracking-wider mb-1">\u041E\u0442\u0432\u0435\u0442</div>
                <div class="text-xl font-bold text-green-400">${M(o.answer??"")}</div>
              </div>
              <div class="flex gap-3">
                <button id="btn-wrong"
                  class="flex-1 py-4 bg-red-700 hover:bg-red-600 text-white rounded-2xl font-bold text-lg transition shadow-lg shadow-red-950/50 flex flex-col items-center gap-0.5">
                  <span class="text-2xl">\u2715</span><span>\u041D\u0435\u0432\u0435\u0440\u043D\u043E</span>
                </button>
                <button id="btn-correct"
                  class="flex-1 py-4 bg-green-700 hover:bg-green-600 text-white rounded-2xl font-bold text-lg transition shadow-lg shadow-green-950/50 flex flex-col items-center gap-0.5">
                  <span class="text-2xl">\u2713</span><span>\u041F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u043E +${_.pack.starsPerCorrect}\u2605</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Right panel -->
          <div class="w-[300px] flex-shrink-0 bg-gray-900 border-l border-gray-800 flex flex-col">
            <div class="flex-1 min-h-0 flex flex-col items-center justify-evenly px-6 py-2 overflow-hidden">
              <div class="flex flex-col items-center gap-1 w-full">
                <div class="${d(r)}">
                  ${s(r)}
                </div>
                ${a(r)}
              </div>
              <div class="text-gray-600 text-base">\u2193</div>
              <div class="flex flex-col items-center gap-1 w-full">
                <div class="${d(n)}">
                  ${n?s(n,!0):'<span class="text-3xl">\u{1F3C6}</span>'}
                </div>
                ${n?a(n,!0):'<div class="text-xs text-gray-500 text-center">\u0424\u0438\u043D\u0430\u043B!</div>'}
              </div>
            </div>
            <div class="px-4 pb-4 pt-3 border-t border-gray-800 flex-shrink-0 space-y-2">
              ${l("h-11")}
            </div>
          </div>

        </div>
      </div>`,o.fen){let x=e.querySelector("#board-container");ct=oo(x,o.fen,o.boardOrientation??"white"),ue=new Mt(o.fen),ue.inCheck()&&ct.set({check:ue.turn()==="w"?"white":"black"})}let u=(o.solutionMovesUci?.length??0)+1,f=!1,m=()=>{let x=e.querySelector("#nav-pos");x&&(x.textContent=`${re+1} / ${u}`),e.querySelector("#btn-nav-prev")?.toggleAttribute("disabled",f||re<=0),e.querySelector("#btn-nav-next")?.toggleAttribute("disabled",f||re>=u-1)},v=x=>{f=x,m(),e.querySelector("#btn-correct")?.toggleAttribute("disabled",x),e.querySelector("#btn-wrong")?.toggleAttribute("disabled",x),e.querySelector("#nav-lock-indicator")?.classList.toggle("hidden",!x)},b=x=>{if(!ct||!ue||!o.solutionMovesUci)return;if(x=Math.max(0,Math.min(x,o.solutionMovesUci.length)),x<re)for(let Z=re;Z>x;Z--)ue.undo();else for(let Z=re;Z<x;Z++){let U=o.solutionMovesUci[Z];ue.move({from:U.slice(0,2),to:U.slice(2,4),promotion:U[4]})}re=x;let A=re>0?o.solutionMovesUci[re-1]:null,q=A?[A.slice(0,2),A.slice(2,4)]:void 0,ne=ue.inCheck()?ue.turn()==="w"?"white":"black":!1;ct.set({fen:ue.fen(),lastMove:q,check:ne}),m()};o.solutionMovesUci&&o.solutionMovesUci.length>0&&(e.querySelector("#btn-nav-prev")?.addEventListener("click",()=>b(re-1)),e.querySelector("#btn-nav-next")?.addEventListener("click",()=>b(re+1)),le=x=>{(x.key==="l"||x.key==="L"||x.key==="\u0434"||x.key==="\u0414")&&!x.ctrlKey&&!x.metaKey&&!x.altKey&&v(!f)},document.addEventListener("keydown",le)),e.querySelector("#btn-show-answer")?.addEventListener("click",()=>{e.querySelector("#btn-show-answer")?.classList.add("hidden"),e.querySelector("#answer-block")?.classList.remove("hidden"),Ke()}),e.querySelector("#btn-correct")?.addEventListener("click",()=>mo(!0)),e.querySelector("#btn-wrong")?.addEventListener("click",()=>mo(!1)),e.querySelector("#btn-all-chars")?.addEventListener("click",()=>ia()),e.querySelector("#btn-exit")?.addEventListener("click",()=>{Y("\u0412\u044B\u0439\u0442\u0438 \u0438\u0437 \u0438\u0433\u0440\u044B? \u041F\u0440\u043E\u0433\u0440\u0435\u0441\u0441 \u0441\u043E\u0445\u0440\u0430\u043D\u0451\u043D.",()=>{Ke(),le&&(document.removeEventListener("keydown",le),le=null),Ae("home")})}),_.timerSeconds>0&&Eo(_.timerSeconds)}function ia(){if(!_)return;document.getElementById("all-chars-overlay")?.remove();let e=dt!==null,t=Oe;Ke();let r=_.characterSet.characters,n=r[r.length-1]?.cost??0,o=document.createElement("div");o.id="all-chars-overlay",o.className="fixed inset-0 bg-black/75 backdrop-blur-sm flex items-center justify-center z-50 p-4";let i=(a,d)=>{let l=a?we(a):"";return l?`<img src="${l}" alt="" class="${`w-24 h-24 object-contain rounded-xl mb-2 ${d?"":"grayscale opacity-30"}`}" />`:`<div class="${`w-24 h-24 rounded-xl mb-2 flex items-center justify-center text-4xl
      ${d?"bg-gray-700":"bg-gray-800 opacity-30"}`}">${d?"\u{1F464}":"\u{1F512}"}</div>`};o.innerHTML=`
    <div class="bg-gray-900 border border-gray-800 rounded-2xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[85vh]">

      <!-- Header -->
      <div class="flex items-center justify-between px-5 py-4 border-b border-gray-800">
        <div>
          <div class="font-bold text-lg">\u0412\u0441\u0435 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0438</div>
          <div class="text-xs text-gray-400 mt-0.5">
            \u041D\u0430\u0431\u0440\u0430\u043D\u043E: <span class="text-yellow-400 font-bold">\u2605 ${_.totalStars}</span>
            &nbsp;\xB7&nbsp;
            \u0414\u043B\u044F \u0432\u0441\u0435\u0445: <span class="text-gray-300 font-semibold">\u2605 ${n}</span>
          </div>
        </div>
        <button id="btn-close-overlay"
          class="text-gray-400 hover:text-white text-2xl leading-none transition w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-800">
          \xD7
        </button>
      </div>

      <!-- Overall progress bar -->
      <div class="px-5 py-3 border-b border-gray-800">
        <div class="flex justify-between text-xs text-gray-500 mb-1.5">
          <span>\u041E\u0431\u0449\u0438\u0439 \u043F\u0440\u043E\u0433\u0440\u0435\u0441\u0441</span>
          <span>${Math.round(Math.min(100,_.totalStars/(n||1)*100))}%</span>
        </div>
        <div class="w-full bg-gray-700 rounded-full h-2.5 overflow-hidden">
          <div class="bg-yellow-400 h-2.5 rounded-full transition-all"
            style="width:${Math.min(100,_.totalStars/(n||1)*100)}%"></div>
        </div>
      </div>

      <!-- Characters grid -->
      <div class="grid grid-cols-4 gap-4 p-5 overflow-y-auto flex-1">
        ${r.map((a,d)=>{let l=d<=_.unlockedUpTo;return`
            <div class="flex flex-col items-center rounded-xl p-3
              ${l?"bg-gray-800 border border-gray-700":"bg-gray-900 border border-gray-800"}">
              ${i(a.imageUrl,l)}
              <div class="text-xs font-semibold text-center leading-tight
                ${l?"text-white":"text-gray-600"}">
                ${M(a.name)}
              </div>
              <div class="text-xs mt-1 ${l?"text-yellow-400":"text-gray-700"}">
                ${l?"\u2713":"\u{1F512}"} \u2605 ${a.cost}
              </div>
            </div>
          `}).join("")}
      </div>

    </div>
  `,document.body.appendChild(o);let s=()=>{o.remove(),e&&t>0&&Eo(t)};o.querySelector("#btn-close-overlay")?.addEventListener("click",s),o.addEventListener("click",a=>{a.target===o&&s()})}function Eo(e){Ke(),Oe=e,go(),dt=window.setInterval(()=>{Oe--,go(),Oe<=0&&(Ke(),document.getElementById("btn-show-answer")?.classList.add("hidden"),document.getElementById("answer-block")?.classList.remove("hidden"))},1e3)}function Ke(){dt!==null&&(clearInterval(dt),dt=null)}function go(){let e=document.getElementById("timer-display");e&&(e.textContent=String(Oe),Oe<=5?e.className="text-6xl font-black text-red-500 leading-none":Oe<=10?e.className="text-6xl font-black text-yellow-400 leading-none":e.className="text-6xl font-black text-white leading-none")}function mo(e){if(_){if(Ke(),e){_.totalStars+=_.pack.starsPerCorrect;let t=_.characterSet.characters,r=null;for(;_.unlockedUpTo+1<t.length&&_.totalStars>=t[_.unlockedUpTo+1].cost;)_.unlockedUpTo++,r=t[_.unlockedUpTo];if(Lt(_),r){let o=_.unlockedUpTo>=t.length-1?()=>{_.currentIndex++,lt(_.id),Co(),Ae("results")}:()=>vo();sa(r,o);return}}vo()}}function sa(e,t){let r=document.createElement("div");r.className="fixed inset-0 bg-black/85 backdrop-blur-md flex items-center justify-center z-50";let n=e.imageUrl?we(e.imageUrl):"";r.innerHTML=`
    <div class="text-center px-6">
      <div class="text-6xl mb-4">\u{1F389}</div>
      <div class="text-yellow-400 text-3xl font-black mb-4">\u041D\u043E\u0432\u044B\u0439 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436!</div>
      ${n?`<img src="${n}" alt="${M(e.name)}"
             class="w-36 h-36 object-contain mx-auto mb-4 rounded-2xl" />`:'<div class="w-36 h-36 bg-gray-700 rounded-2xl mx-auto mb-4 flex items-center justify-center text-6xl">\u2B50</div>'}
      <div class="text-3xl font-bold text-white mb-1">${M(e.name)}</div>
      <div class="text-gray-400 text-sm mb-8">\u041E\u0442\u043A\u0440\u044B\u0442 \u0437\u0430 ${e.cost} \u0437\u0432\u0451\u0437\u0434</div>
      <button id="btn-unlock-ok"
        class="py-3 px-12 bg-yellow-500 hover:bg-yellow-400 text-black font-bold rounded-2xl text-lg transition">
        \u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C
      </button>
    </div>
  `,document.body.appendChild(r),r.querySelector("#btn-unlock-ok")?.addEventListener("click",()=>{r.remove(),t()})}function vo(){if(_){if(_.currentIndex++,_.currentIndex>=_.shuffledQuestions.length)if(!(_.unlockedUpTo>=_.characterSet.characters.length-1)&&_.spareQuestions.length>0){let t=_.spareQuestions.shift();t&&_.shuffledQuestions.push(t)}else{lt(_.id),Co(),Ae("results");return}Lt(_),vr()}}function Co(){if(!_)return;le&&(document.removeEventListener("keydown",le),le=null);let e=document.getElementById("screen-results"),t=_.characterSet.characters,r=_.unlockedUpTo>=0?t.slice(0,_.unlockedUpTo+1):[],n=_.unlockedUpTo>=0?t[_.unlockedUpTo]??null:null,o=(i,s)=>{let a=i?we(i):"";return a?`<img src="${a}" alt="" class="${s}" />`:`<div class="${s} bg-gray-700 flex items-center justify-center text-4xl">\u2B50</div>`};e.innerHTML=`
    <div class="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-950">
      <div class="text-6xl mb-3">\u{1F3C6}</div>
      <h1 class="text-3xl font-black text-yellow-400 mb-1">\u0418\u0433\u0440\u0430 \u0437\u0430\u0432\u0435\u0440\u0448\u0435\u043D\u0430!</h1>
      <div class="text-gray-400 mb-8 text-sm">
        ${_.currentIndex} / ${_.shuffledQuestions.length} \u0432\u043E\u043F\u0440\u043E\u0441\u043E\u0432 \xB7 ${_.totalStars} \u0437\u0432\u0451\u0437\u0434 \u043D\u0430\u0431\u0440\u0430\u043D\u043E
      </div>

      <div class="bg-gray-900 border border-gray-800 rounded-2xl p-6 text-center w-full max-w-xs mb-6">
        <div class="text-xs text-gray-400 uppercase tracking-wider mb-3">\u0424\u0438\u043D\u0430\u043B\u044C\u043D\u044B\u0439 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436</div>
        ${n?`${o(n.imageUrl,"w-32 h-32 object-contain mx-auto mb-3 rounded-xl")}
             <div class="text-2xl font-bold">${M(n.name)}</div>`:`<div class="w-32 h-32 bg-gray-800 rounded-xl mx-auto mb-3 flex items-center justify-center text-5xl">\u{1F614}</div>
             <div class="text-xl font-bold text-gray-500">\u041D\u0438 \u043E\u0434\u043D\u043E\u0433\u043E \u043D\u0435 \u043E\u0442\u043A\u0440\u044B\u0442\u043E</div>`}
        <div class="text-yellow-400 mt-1 text-sm">\u2605 ${_.totalStars}</div>
      </div>

      ${r.length>1?`
        <div class="w-full max-w-md mb-8">
          <div class="text-xs text-gray-500 uppercase tracking-wider text-center mb-3">
            \u041E\u0442\u043A\u0440\u044B\u0442\u043E: ${r.length} / ${t.length}
          </div>
          <div class="flex flex-wrap gap-2 justify-center">
            ${r.map(i=>`
              <div class="flex flex-col items-center bg-gray-900 border border-gray-800 rounded-xl p-2 w-20">
                ${o(i.imageUrl,"w-12 h-12 object-contain rounded-lg")}
                <div class="text-xs text-center text-gray-300 mt-1 leading-tight">${M(i.name)}</div>
              </div>
            `).join("")}
          </div>
        </div>
      `:""}

      <button id="btn-home"
        class="py-3 px-10 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-lg transition">
        \u041D\u0430 \u0433\u043B\u0430\u0432\u043D\u0443\u044E
      </button>
    </div>
  `,e.querySelector("#btn-home")?.addEventListener("click",()=>{_=null,Ae("home")})}var br=()=>{};function $o(e){br=e}var y=Po();function Po(){return{packs:[],view:"list",editIdx:-1,pack:{title:"",questions:[],starsPerCorrect:3},expandedQ:-1}}function Mo(e){y=Po(),y.packs=st(),We(e)}function We(e){y.view==="list"?Tt(e):aa(e)}function Tt(e){e.innerHTML=`
    <div class="min-h-screen flex flex-col bg-gray-950">

      <div class="flex items-center gap-3 px-5 py-4 bg-gray-900 border-b border-gray-800">
        <button id="pe-back" class="text-gray-400 hover:text-white transition text-sm">\u2190 \u041D\u0430\u0437\u0430\u0434</button>
        <h1 class="text-xl font-bold flex-1">\u0420\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u0432\u043E\u043F\u0440\u043E\u0441\u043E\u0432</h1>
        <label class="cursor-pointer text-sm text-indigo-400 hover:text-indigo-300 transition">
          \u0418\u043C\u043F\u043E\u0440\u0442
          <input id="pe-import" type="file" accept=".json" class="hidden" />
        </label>
        <button id="pe-new" class="py-2 px-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-sm font-semibold transition">
          + \u041D\u043E\u0432\u044B\u0439 \u043F\u0430\u043A\u0435\u0442
        </button>
      </div>

      <div class="flex-1 p-4 max-w-2xl mx-auto w-full">
        ${y.packs.length===0?'<div class="text-gray-500 text-center mt-20 text-sm">\u041D\u0435\u0442 \u043F\u0430\u043A\u0435\u0442\u043E\u0432. \u0421\u043E\u0437\u0434\u0430\u0439\u0442\u0435 \u043F\u0435\u0440\u0432\u044B\u0439!</div>':y.packs.map((t,r)=>`
            <div class="bg-gray-900 border border-gray-800 rounded-xl px-4 py-3 flex items-center gap-3 mb-2">
              <div class="flex-1 min-w-0">
                <div class="font-semibold truncate">${M(t.title)}</div>
                <div class="text-xs text-gray-400">${t.questions.length} \u0432\u043E\u043F\u0440\u043E\u0441\u043E\u0432 \xB7 ${t.starsPerCorrect}\u2605 \u0437\u0430 \u043E\u0442\u0432\u0435\u0442</div>
              </div>
              <button data-edit="${r}" class="text-sm text-indigo-400 hover:text-indigo-300 transition">\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C</button>
              <button data-copy="${r}" class="text-sm text-green-400 hover:text-green-300 transition">\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C</button>
              <button data-export="${r}" class="text-sm text-gray-400 hover:text-gray-300 transition">\u042D\u043A\u0441\u043F\u043E\u0440\u0442</button>
              <button data-del="${r}" class="text-sm text-red-400 hover:text-red-300 transition">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
            </div>
          `).join("")}
      </div>

    </div>
  `,e.querySelector("#pe-back")?.addEventListener("click",()=>br("home")),e.querySelector("#pe-new")?.addEventListener("click",()=>{y.editIdx=-1,y.pack={title:"",questions:[],starsPerCorrect:3},y.view="edit",y.expandedQ=-1,We(e)}),e.querySelector("#pe-import")?.addEventListener("change",t=>{let r=t.target.files?.[0];if(!r)return;let n=new FileReader;n.onload=o=>{try{let i=JSON.parse(o.target?.result);if(!i.title||!Array.isArray(i.questions)||typeof i.starsPerCorrect!="number"||!i.questions.every(s=>{let a=s;return a&&typeof a.text=="string"&&(a.answer===void 0||typeof a.answer=="string")}))throw new Error;y.packs.push(i),Be(y.packs),Tt(e)}catch{Y("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u0444\u0430\u0439\u043B\u0430")}},n.readAsText(r)}),e.querySelectorAll("[data-edit]").forEach(t=>{t.addEventListener("click",()=>{let r=parseInt(t.dataset.edit);y.editIdx=r,y.pack=structuredClone(y.packs[r]),y.view="edit",y.expandedQ=-1,We(e)})}),e.querySelectorAll("[data-export]").forEach(t=>{t.addEventListener("click",()=>{let r=parseInt(t.dataset.export);Ot(y.packs[r],`${y.packs[r].title||"pack"}.json`)})}),e.querySelectorAll("[data-del]").forEach(t=>{t.addEventListener("click",()=>{let r=parseInt(t.dataset.del);Y(`\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0430\u043A\u0435\u0442 \xAB${M(y.packs[r].title)}\xBB?`,()=>{y.packs.splice(r,1),Be(y.packs),Tt(e)})})}),e.querySelectorAll("[data-copy]").forEach(t=>{t.addEventListener("click",()=>{let r=parseInt(t.dataset.copy),n=structuredClone(y.packs[r]);n.title+=" (\u043A\u043E\u043F\u0438\u044F)",y.packs.push(n),Be(y.packs),Tt(e)})})}function aa(e){let t=y.pack;e.innerHTML=`
    <div class="min-h-screen flex flex-col bg-gray-950">

      <div class="flex items-center gap-3 px-5 py-4 bg-gray-900 border-b border-gray-800">
        <button id="pe-edit-back" class="text-gray-400 hover:text-white transition text-sm">\u2190 \u041D\u0430\u0437\u0430\u0434</button>
        <h1 class="text-xl font-bold flex-1">${y.editIdx===-1?"\u041D\u043E\u0432\u044B\u0439 \u043F\u0430\u043A\u0435\u0442":"\u0420\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043F\u0430\u043A\u0435\u0442"}</h1>
        <button id="pe-save" class="py-2 px-4 bg-green-700 hover:bg-green-600 text-white rounded-xl text-sm font-semibold transition">
          \u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C
        </button>
      </div>

      <div class="flex-1 p-4 max-w-2xl mx-auto w-full space-y-4">

        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4 space-y-3">
          <div>
            <label class="text-xs text-gray-400 uppercase tracking-wider">\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043F\u0430\u043A\u0435\u0442\u0430</label>
            <input id="pe-title" type="text" value="${M(t.title)}" placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435..."
              class="w-full bg-gray-800 text-white rounded-xl px-4 py-2 mt-1 border border-gray-700 focus:outline-none focus:border-indigo-500" />
          </div>
          <div>
            <label class="text-xs text-gray-400 uppercase tracking-wider">\u0417\u0432\u0451\u0437\u0434 \u0437\u0430 \u043F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u044B\u0439 \u043E\u0442\u0432\u0435\u0442</label>
            <input id="pe-stars" type="number" min="1" max="100" value="${t.starsPerCorrect}"
              class="w-full bg-gray-800 text-white rounded-xl px-4 py-2 mt-1 border border-gray-700 focus:outline-none focus:border-indigo-500" />
          </div>
        </div>

        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-400 uppercase tracking-wider font-semibold">\u0412\u043E\u043F\u0440\u043E\u0441\u044B (${t.questions.length})</div>
          <button id="pe-add-q" class="py-1.5 px-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-semibold transition">
            + \u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C
          </button>
        </div>

        <div id="pe-qlist">${Ao(t.questions)}</div>

        ${y.editIdx!==-1?`
          <button id="pe-del-pack"
            class="w-full py-3 rounded-xl font-semibold transition text-red-400 hover:text-red-300 border border-red-900 hover:bg-red-900/20">
            \u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0430\u043A\u0435\u0442
          </button>
        `:""}

      </div>
    </div>
  `;let r=e.querySelector("#pe-title"),n=e.querySelector("#pe-stars");r.addEventListener("input",()=>{y.pack.title=r.value}),n.addEventListener("input",()=>{y.pack.starsPerCorrect=Math.max(1,parseInt(n.value)||1)}),e.querySelector("#pe-edit-back")?.addEventListener("click",()=>{y.view="list",y.packs=st(),We(e)}),e.querySelector("#pe-save")?.addEventListener("click",()=>{if(!y.pack.title.trim()){Y("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043F\u0430\u043A\u0435\u0442\u0430");return}y.editIdx===-1?y.packs.push(y.pack):y.packs[y.editIdx]=y.pack,Be(y.packs),y.view="list",We(e)}),e.querySelector("#pe-del-pack")?.addEventListener("click",()=>{Y(`\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043F\u0430\u043A\u0435\u0442 \xAB${M(y.pack.title)}\xBB?`,()=>{y.packs.splice(y.editIdx,1),Be(y.packs),y.view="list",We(e)})}),e.querySelector("#pe-add-q")?.addEventListener("click",()=>{y.pack.questions.push({text:"",answer:""}),y.expandedQ=y.pack.questions.length-1,ut(e),setTimeout(()=>{e.querySelector(`[data-qrow="${y.expandedQ}"]`)?.scrollIntoView({behavior:"smooth",block:"center"})},50)}),Lo(e)}function Ao(e){return e.length===0?'<div class="text-gray-500 text-center py-8 text-sm">\u041D\u0435\u0442 \u0432\u043E\u043F\u0440\u043E\u0441\u043E\u0432. \u041D\u0430\u0436\u043C\u0438\u0442\u0435 \xAB+ \u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C\xBB.</div>':e.map((t,r)=>{let n=y.expandedQ===r;return`
      <div data-qrow="${r}" class="bg-gray-900 border border-gray-800 rounded-xl mb-2 overflow-hidden">
        <div class="flex items-center gap-3 px-4 py-3 cursor-pointer select-none" data-qtoggle="${r}">
          <div class="flex-1 min-w-0">
            <div class="text-sm font-medium truncate ${t.text?"text-white":"text-gray-500 italic"}">
              ${t.text?M(t.text):"\u0411\u0435\u0437 \u0442\u0435\u043A\u0441\u0442\u0430"}
            </div>
            <div class="text-xs text-gray-400 truncate">${t.answer?M(t.answer):"\u0411\u0435\u0437 \u043E\u0442\u0432\u0435\u0442\u0430"}</div>
          </div>
          <div class="flex gap-0.5 flex-shrink-0">
            <button data-qup="${r}" class="text-gray-400 hover:text-white transition px-2 py-1 text-sm" title="\u0412\u0432\u0435\u0440\u0445">\u2191</button>
            <button data-qdn="${r}" class="text-gray-400 hover:text-white transition px-2 py-1 text-sm" title="\u0412\u043D\u0438\u0437">\u2193</button>
            <button data-qdel="${r}" class="text-red-400 hover:text-red-300 text-sm transition px-2 py-1">\u2715</button>
          </div>
          <span class="text-gray-600 text-sm flex-shrink-0">${n?"\u25B2":"\u25BC"}</span>
        </div>
        ${n?`
          <div class="px-4 pb-4 pt-3 space-y-2 border-t border-gray-800">
            <div>
              <label class="text-xs text-gray-400">\u0412\u043E\u043F\u0440\u043E\u0441</label>
              <textarea data-qtext="${r}" rows="2" placeholder="\u0422\u0435\u043A\u0441\u0442 \u0432\u043E\u043F\u0440\u043E\u0441\u0430..."
                class="w-full bg-gray-800 text-white rounded-lg px-3 py-2 mt-1 text-sm border border-gray-700 focus:outline-none focus:border-indigo-500 resize-none">${M(t.text)}</textarea>
            </div>
            <div>
              <label class="text-xs text-gray-400">\u041E\u0442\u0432\u0435\u0442</label>
              <input data-qans="${r}" type="text" value="${M(t.answer??"")}" placeholder="\u041F\u0440\u0430\u0432\u0438\u043B\u044C\u043D\u044B\u0439 \u043E\u0442\u0432\u0435\u0442..."
                class="w-full bg-gray-800 text-white rounded-lg px-3 py-2 mt-1 text-sm border border-gray-700 focus:outline-none focus:border-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-gray-400">\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 (URL, \u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)</label>
              <input data-qimg="${r}" type="text" value="${M(t.imageUrl??"")}" placeholder="https://..."
                class="w-full bg-gray-800 text-white rounded-lg px-3 py-2 mt-1 text-sm border border-gray-700 focus:outline-none focus:border-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-gray-400">FEN \u043F\u043E\u0437\u0438\u0446\u0438\u044F (\u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E, \u0434\u043B\u044F \u0448\u0430\u0445\u043C\u0430\u0442)</label>
              <input data-qfen="${r}" type="text" value="${M(t.fen??"")}" placeholder="rnbqkbnr/pppppppp/8/8/4P3/8/PPPP1PPP/RNBQKBNR b KQkq e3 0 1"
                class="w-full bg-gray-800 text-white rounded-lg px-3 py-2 mt-1 text-sm border border-gray-700 focus:outline-none focus:border-indigo-500 font-mono text-xs" />
            </div>
            <div>
              <label class="text-xs text-gray-400">\u041E\u0440\u0438\u0435\u043D\u0442\u0430\u0446\u0438\u044F \u0434\u043E\u0441\u043A\u0438</label>
              <select data-qorient="${r}"
                class="w-full bg-gray-800 text-white rounded-lg px-3 py-2 mt-1 text-sm border border-gray-700 focus:outline-none focus:border-indigo-500">
                <option value="" ${t.boardOrientation?"":"selected"}>\u0410\u0432\u0442\u043E (\u0431\u0435\u043B\u044B\u0435 \u0441\u043D\u0438\u0437\u0443)</option>
                <option value="white" ${t.boardOrientation==="white"?"selected":""}>\u0411\u0435\u043B\u044B\u0435 \u0441\u043D\u0438\u0437\u0443</option>
                <option value="black" ${t.boardOrientation==="black"?"selected":""}>\u0427\u0451\u0440\u043D\u044B\u0435 \u0441\u043D\u0438\u0437\u0443</option>
              </select>
            </div>
          </div>
        `:""}
      </div>
    `}).join("")}function ut(e){let t=e.querySelector("#pe-qlist");t&&(t.innerHTML=Ao(y.pack.questions)),Lo(e)}function Lo(e){e.querySelectorAll("[data-qtoggle]").forEach(t=>{t.addEventListener("click",r=>{let n=r.target;if(n.hasAttribute("data-qdel")||n.hasAttribute("data-qup")||n.hasAttribute("data-qdn"))return;let o=parseInt(t.dataset.qtoggle);y.expandedQ=y.expandedQ===o?-1:o,ut(e)})}),e.querySelectorAll("[data-qdel]").forEach(t=>{t.addEventListener("click",r=>{r.stopPropagation();let n=parseInt(t.dataset.qdel);y.pack.questions.splice(n,1),y.expandedQ===n?y.expandedQ=-1:y.expandedQ>n&&y.expandedQ--,ut(e)})}),e.querySelectorAll("[data-qup]").forEach(t=>{t.addEventListener("click",r=>{r.stopPropagation();let n=parseInt(t.dataset.qup);n!==0&&([y.pack.questions[n-1],y.pack.questions[n]]=[y.pack.questions[n],y.pack.questions[n-1]],y.expandedQ===n?y.expandedQ=n-1:y.expandedQ===n-1&&(y.expandedQ=n),ut(e))})}),e.querySelectorAll("[data-qdn]").forEach(t=>{t.addEventListener("click",r=>{r.stopPropagation();let n=parseInt(t.dataset.qdn);n>=y.pack.questions.length-1||([y.pack.questions[n+1],y.pack.questions[n]]=[y.pack.questions[n],y.pack.questions[n+1]],y.expandedQ===n?y.expandedQ=n+1:y.expandedQ===n+1&&(y.expandedQ=n),ut(e))})}),e.querySelectorAll("[data-qtext]").forEach(t=>{t.addEventListener("input",()=>{y.pack.questions[parseInt(t.dataset.qtext)].text=t.value})}),e.querySelectorAll("[data-qans]").forEach(t=>{t.addEventListener("input",()=>{y.pack.questions[parseInt(t.dataset.qans)].answer=t.value||void 0})}),e.querySelectorAll("[data-qimg]").forEach(t=>{t.addEventListener("input",()=>{y.pack.questions[parseInt(t.dataset.qimg)].imageUrl=t.value||void 0})}),e.querySelectorAll("[data-qfen]").forEach(t=>{t.addEventListener("input",()=>{y.pack.questions[parseInt(t.dataset.qfen)].fen=t.value||void 0})}),e.querySelectorAll("[data-qorient]").forEach(t=>{t.addEventListener("change",()=>{let r=t.value;y.pack.questions[parseInt(t.dataset.qorient)].boardOrientation=r||void 0})})}var k=To();function To(){return{sets:[],view:"list",editIdx:-1,set:{title:"",characters:[]},expandedC:-1}}function qo(e){k=To(),k.sets=at(),ze(e)}function ze(e){k.view==="list"?qt(e):la(e)}function qt(e){e.innerHTML=`
    <div class="min-h-screen flex flex-col bg-gray-950">

      <div class="flex items-center gap-3 px-5 py-4 bg-gray-900 border-b border-gray-800">
        <button id="ce-back" class="text-gray-400 hover:text-white transition text-sm">\u2190 \u041D\u0430\u0437\u0430\u0434</button>
        <h1 class="text-xl font-bold flex-1">\u0420\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0435\u0439</h1>
        <label class="cursor-pointer text-sm text-indigo-400 hover:text-indigo-300 transition">
          \u0418\u043C\u043F\u043E\u0440\u0442
          <input id="ce-import" type="file" accept=".json" class="hidden" />
        </label>
        <button id="ce-new" class="py-2 px-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-sm font-semibold transition">
          + \u041D\u043E\u0432\u044B\u0439 \u043D\u0430\u0431\u043E\u0440
        </button>
      </div>

      <div class="flex-1 p-4 max-w-2xl mx-auto w-full">
        ${k.sets.length===0?'<div class="text-gray-500 text-center mt-20 text-sm">\u041D\u0435\u0442 \u043D\u0430\u0431\u043E\u0440\u043E\u0432. \u0421\u043E\u0437\u0434\u0430\u0439\u0442\u0435 \u043F\u0435\u0440\u0432\u044B\u0439!</div>':k.sets.map((t,r)=>`
            <div class="bg-gray-900 border border-gray-800 rounded-xl px-4 py-3 flex items-center gap-3 mb-2">
              <div class="flex-1 min-w-0">
                <div class="font-semibold truncate">${M(t.title)}</div>
                <div class="text-xs text-gray-400">${t.characters.length} \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0435\u0439</div>
              </div>
              <button data-edit="${r}" class="text-sm text-indigo-400 hover:text-indigo-300 transition">\u0418\u0437\u043C\u0435\u043D\u0438\u0442\u044C</button>
              <button data-copy="${r}" class="text-sm text-green-400 hover:text-green-300 transition">\u041A\u043E\u043F\u0438\u0440\u043E\u0432\u0430\u0442\u044C</button>
              <button data-export="${r}" class="text-sm text-gray-400 hover:text-gray-300 transition">\u042D\u043A\u0441\u043F\u043E\u0440\u0442</button>
              <button data-del="${r}" class="text-sm text-red-400 hover:text-red-300 transition">\u0423\u0434\u0430\u043B\u0438\u0442\u044C</button>
            </div>
          `).join("")}
      </div>

    </div>
  `,e.querySelector("#ce-back")?.addEventListener("click",()=>br("home")),e.querySelector("#ce-new")?.addEventListener("click",()=>{k.editIdx=-1,k.set={title:"",characters:[]},k.view="edit",k.expandedC=-1,ze(e)}),e.querySelector("#ce-import")?.addEventListener("change",t=>{let r=t.target.files?.[0];if(!r)return;let n=new FileReader;n.onload=o=>{try{let i=JSON.parse(o.target?.result);if(!i.title||!Array.isArray(i.characters)||!i.characters.every(s=>{let a=s;return a&&typeof a.name=="string"&&typeof a.cost=="number"}))throw new Error;k.sets.push(i),Fe(k.sets),qt(e)}catch{Y("\u041D\u0435\u0432\u0435\u0440\u043D\u044B\u0439 \u0444\u043E\u0440\u043C\u0430\u0442 \u0444\u0430\u0439\u043B\u0430")}},n.readAsText(r)}),e.querySelectorAll("[data-edit]").forEach(t=>{t.addEventListener("click",()=>{let r=parseInt(t.dataset.edit);k.editIdx=r,k.set=structuredClone(k.sets[r]),k.view="edit",k.expandedC=-1,ze(e)})}),e.querySelectorAll("[data-export]").forEach(t=>{t.addEventListener("click",()=>{let r=parseInt(t.dataset.export);Ot(k.sets[r],`${k.sets[r].title||"characters"}.json`)})}),e.querySelectorAll("[data-del]").forEach(t=>{t.addEventListener("click",()=>{let r=parseInt(t.dataset.del);Y(`\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043D\u0430\u0431\u043E\u0440 \xAB${M(k.sets[r].title)}\xBB?`,()=>{k.sets.splice(r,1),Fe(k.sets),qt(e)})})}),e.querySelectorAll("[data-copy]").forEach(t=>{t.addEventListener("click",()=>{let r=parseInt(t.dataset.copy),n=structuredClone(k.sets[r]);n.title+=" (\u043A\u043E\u043F\u0438\u044F)",k.sets.push(n),Fe(k.sets),qt(e)})})}function la(e){let t=k.set;e.innerHTML=`
    <div class="min-h-screen flex flex-col bg-gray-950">

      <div class="flex items-center gap-3 px-5 py-4 bg-gray-900 border-b border-gray-800">
        <button id="ce-edit-back" class="text-gray-400 hover:text-white transition text-sm">\u2190 \u041D\u0430\u0437\u0430\u0434</button>
        <h1 class="text-xl font-bold flex-1">${k.editIdx===-1?"\u041D\u043E\u0432\u044B\u0439 \u043D\u0430\u0431\u043E\u0440":"\u0420\u0435\u0434\u0430\u043A\u0442\u0438\u0440\u043E\u0432\u0430\u0442\u044C \u043D\u0430\u0431\u043E\u0440"}</h1>
        <button id="ce-save" class="py-2 px-4 bg-green-700 hover:bg-green-600 text-white rounded-xl text-sm font-semibold transition">
          \u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C
        </button>
      </div>

      <div class="flex-1 p-4 max-w-2xl mx-auto w-full space-y-4">

        <div class="bg-gray-900 border border-gray-800 rounded-xl p-4">
          <label class="text-xs text-gray-400 uppercase tracking-wider">\u041D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043D\u0430\u0431\u043E\u0440\u0430</label>
          <input id="ce-title" type="text" value="${M(t.title)}" placeholder="\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435..."
            class="w-full bg-gray-800 text-white rounded-xl px-4 py-2 mt-1 border border-gray-700 focus:outline-none focus:border-indigo-500" />
        </div>

        <div class="text-xs text-gray-500 px-1">
          \u{1F4A1} \u041F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0438 \u0441\u043E\u0440\u0442\u0438\u0440\u0443\u044E\u0442\u0441\u044F \u043F\u043E \u0441\u0442\u043E\u0438\u043C\u043E\u0441\u0442\u0438 \u0430\u0432\u0442\u043E\u043C\u0430\u0442\u0438\u0447\u0435\u0441\u043A\u0438. \u0427\u0435\u043C \u0432\u044B\u0448\u0435 \u0441\u0442\u043E\u0438\u043C\u043E\u0441\u0442\u044C, \u0442\u0435\u043C \u043F\u043E\u0437\u0436\u0435 \u043E\u0442\u043A\u0440\u044B\u0432\u0430\u0435\u0442\u0441\u044F \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436.
        </div>

        <div class="flex items-center justify-between">
          <div class="text-sm text-gray-400 uppercase tracking-wider font-semibold">\u041F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0438 (${t.characters.length})</div>
          <button id="ce-add-c" class="py-1.5 px-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-semibold transition">
            + \u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C
          </button>
        </div>

        <div id="ce-clist">${Io(t.characters)}</div>

        ${k.editIdx!==-1?`
          <button id="ce-del-set"
            class="w-full py-3 rounded-xl font-semibold transition text-red-400 hover:text-red-300 border border-red-900 hover:bg-red-900/20">
            \u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043D\u0430\u0431\u043E\u0440
          </button>
        `:""}

      </div>
    </div>
  `;let r=e.querySelector("#ce-title");r.addEventListener("input",()=>{k.set.title=r.value}),e.querySelector("#ce-edit-back")?.addEventListener("click",()=>{k.view="list",k.sets=at(),ze(e)}),e.querySelector("#ce-save")?.addEventListener("click",()=>{if(!k.set.title.trim()){Y("\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u043D\u0430\u0437\u0432\u0430\u043D\u0438\u0435 \u043D\u0430\u0431\u043E\u0440\u0430");return}k.editIdx===-1?k.sets.push(k.set):k.sets[k.editIdx]=k.set,Fe(k.sets),k.view="list",ze(e)}),e.querySelector("#ce-del-set")?.addEventListener("click",()=>{Y(`\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u043D\u0430\u0431\u043E\u0440 \xAB${M(k.set.title)}\xBB?`,()=>{k.sets.splice(k.editIdx,1),Fe(k.sets),k.view="list",ze(e)})}),e.querySelector("#ce-add-c")?.addEventListener("click",()=>{k.set.characters.push({name:"",cost:3}),k.expandedC=k.set.characters.length-1,Qe(e),setTimeout(()=>{e.querySelector(`[data-crow="${k.expandedC}"]`)?.scrollIntoView({behavior:"smooth",block:"center"})},50)}),No(e)}function Io(e){return e.length===0?'<div class="text-gray-500 text-center py-8 text-sm">\u041D\u0435\u0442 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0435\u0439. \u041D\u0430\u0436\u043C\u0438\u0442\u0435 \xAB+ \u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C\xBB.</div>':e.map((t,r)=>{let n=k.expandedC===r,o=t.imageUrl?we(t.imageUrl):"";return`
      <div data-crow="${r}" class="bg-gray-900 border border-gray-800 rounded-xl mb-2 overflow-hidden">
        <div class="flex items-center gap-3 px-4 py-3 cursor-pointer select-none" data-ctoggle="${r}">
          ${o?`<img src="${o}" class="w-8 h-8 object-contain rounded flex-shrink-0" />`:'<div class="w-8 h-8 bg-gray-700 rounded flex-shrink-0 flex items-center justify-center text-sm">\u{1F464}</div>'}
          <div class="flex-1 min-w-0">
            <div class="text-sm font-medium ${t.name?"text-white":"text-gray-500 italic"}">
              ${t.name?M(t.name):"\u0411\u0435\u0437 \u0438\u043C\u0435\u043D\u0438"}
            </div>
            <div class="text-xs text-yellow-400">\u2605 ${t.cost}</div>
          </div>
          <div class="flex gap-0.5 flex-shrink-0">
            <button data-cup="${r}" class="text-gray-400 hover:text-white transition px-2 py-1 text-sm" title="\u0412\u0432\u0435\u0440\u0445">\u2191</button>
            <button data-cdn="${r}" class="text-gray-400 hover:text-white transition px-2 py-1 text-sm" title="\u0412\u043D\u0438\u0437">\u2193</button>
            <button data-cdel="${r}" class="text-red-400 hover:text-red-300 text-sm transition px-2 py-1">\u2715</button>
          </div>
          <span class="text-gray-600 text-sm flex-shrink-0">${n?"\u25B2":"\u25BC"}</span>
        </div>
        ${n?`
          <div class="px-4 pb-4 pt-3 space-y-2 border-t border-gray-800">
            <div>
              <label class="text-xs text-gray-400">\u0418\u043C\u044F \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0430</label>
              <input data-cname="${r}" type="text" value="${M(t.name)}" placeholder="\u0418\u043C\u044F..."
                class="w-full bg-gray-800 text-white rounded-lg px-3 py-2 mt-1 text-sm border border-gray-700 focus:outline-none focus:border-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-gray-400">\u0421\u0442\u043E\u0438\u043C\u043E\u0441\u0442\u044C (\u2605 \u0434\u043B\u044F \u043E\u0442\u043A\u0440\u044B\u0442\u0438\u044F)</label>
              <input data-ccost="${r}" type="number" min="1" value="${t.cost}"
                class="w-full bg-gray-800 text-white rounded-lg px-3 py-2 mt-1 text-sm border border-gray-700 focus:outline-none focus:border-indigo-500" />
            </div>
            <div>
              <label class="text-xs text-gray-400">\u0418\u0437\u043E\u0431\u0440\u0430\u0436\u0435\u043D\u0438\u0435 (URL, \u043D\u0435\u043E\u0431\u044F\u0437\u0430\u0442\u0435\u043B\u044C\u043D\u043E)</label>
              <input data-cimg="${r}" type="text" value="${M(t.imageUrl??"")}" placeholder="https://..."
                class="w-full bg-gray-800 text-white rounded-lg px-3 py-2 mt-1 text-sm border border-gray-700 focus:outline-none focus:border-indigo-500" />
            </div>
            ${o?`
              <div>
                <div class="text-xs text-gray-400 mb-1">\u041F\u0440\u0435\u0434\u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440</div>
                <img src="${o}" class="h-16 object-contain rounded" onerror="this.style.display='none'" />
              </div>
            `:""}
          </div>
        `:""}
      </div>
    `}).join("")}function Qe(e){let t=e.querySelector("#ce-clist");t&&(t.innerHTML=Io(k.set.characters)),No(e)}function No(e){e.querySelectorAll("[data-ctoggle]").forEach(t=>{t.addEventListener("click",r=>{let n=r.target;if(n.hasAttribute("data-cup")||n.hasAttribute("data-cdn")||n.hasAttribute("data-cdel"))return;let o=parseInt(t.dataset.ctoggle);k.expandedC=k.expandedC===o?-1:o,Qe(e)})}),e.querySelectorAll("[data-cdel]").forEach(t=>{t.addEventListener("click",r=>{r.stopPropagation();let n=parseInt(t.dataset.cdel);k.set.characters.splice(n,1),k.expandedC===n?k.expandedC=-1:k.expandedC>n&&k.expandedC--,Qe(e)})}),e.querySelectorAll("[data-cup]").forEach(t=>{t.addEventListener("click",r=>{r.stopPropagation();let n=parseInt(t.dataset.cup);n!==0&&([k.set.characters[n-1],k.set.characters[n]]=[k.set.characters[n],k.set.characters[n-1]],k.expandedC===n?k.expandedC=n-1:k.expandedC===n-1&&(k.expandedC=n),Qe(e))})}),e.querySelectorAll("[data-cdn]").forEach(t=>{t.addEventListener("click",r=>{r.stopPropagation();let n=parseInt(t.dataset.cdn);n>=k.set.characters.length-1||([k.set.characters[n+1],k.set.characters[n]]=[k.set.characters[n],k.set.characters[n+1]],k.expandedC===n?k.expandedC=n+1:k.expandedC===n+1&&(k.expandedC=n),Qe(e))})}),e.querySelectorAll("[data-cname]").forEach(t=>{t.addEventListener("input",()=>{k.set.characters[parseInt(t.dataset.cname)].name=t.value})}),e.querySelectorAll("[data-ccost]").forEach(t=>{t.addEventListener("input",()=>{k.set.characters[parseInt(t.dataset.ccost)].cost=Math.max(1,parseInt(t.value)||1)})}),e.querySelectorAll("[data-cimg]").forEach(t=>{t.addEventListener("input",()=>{k.set.characters[parseInt(t.dataset.cimg)].imageUrl=t.value||void 0,Qe(e)})})}var ca=["home","setup","game","results","pack-editor","character-editor"];function Ge(e){return document.getElementById(`screen-${e}`)}function Ve(e){ca.forEach(t=>Ge(t).classList.add("hidden")),Ge(e).classList.remove("hidden"),e==="home"?xr():e==="setup"?_o(Ge("setup")):e==="pack-editor"?Mo(Ge("pack-editor")):e==="character-editor"&&qo(Ge("character-editor"))}function xr(){let e=Ge("home"),t=ko();e.innerHTML=`
    <div class="min-h-screen flex flex-col items-center justify-center p-6 bg-gray-950">

      <div class="text-8xl mb-4 select-none">\u{1F3AF}</div>
      <h1 class="text-5xl font-black tracking-tight mb-2">Level Up</h1>
      <p class="text-gray-400 mb-12 text-center text-sm">
        \u041E\u0442\u0432\u0435\u0447\u0430\u0439 \u043D\u0430 \u0432\u043E\u043F\u0440\u043E\u0441\u044B \u2014 \u043E\u0442\u043A\u0440\u044B\u0432\u0430\u0439 \u043D\u043E\u0432\u044B\u0445 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0435\u0439!
      </p>

      <div class="w-full max-w-xs space-y-3">

        <button id="btn-new"
          class="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-2xl font-bold text-xl transition shadow-lg shadow-indigo-900/30">
          \u041D\u043E\u0432\u0430\u044F \u0438\u0433\u0440\u0430
        </button>

        ${t?`
          <button id="btn-continue"
            class="w-full py-4 bg-yellow-500 hover:bg-yellow-400 text-black rounded-2xl font-bold text-xl transition shadow-lg shadow-yellow-900/30">
            \u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C
          </button>
        `:""}

        <button id="btn-pack-ed"
          class="w-full py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-2xl font-semibold transition">
          \u0420\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u0432\u043E\u043F\u0440\u043E\u0441\u043E\u0432
        </button>

        <button id="btn-char-ed"
          class="w-full py-3 bg-gray-800 hover:bg-gray-700 text-white rounded-2xl font-semibold transition">
          \u0420\u0435\u0434\u0430\u043A\u0442\u043E\u0440 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u0436\u0435\u0439
        </button>

      </div>
    </div>
  `,e.querySelector("#btn-new")?.addEventListener("click",()=>Ve("setup")),e.querySelector("#btn-continue")?.addEventListener("click",()=>da()),e.querySelector("#btn-pack-ed")?.addEventListener("click",()=>Ve("pack-editor")),e.querySelector("#btn-char-ed")?.addEventListener("click",()=>Ve("character-editor"))}function da(){if(document.getElementById("save-picker-overlay")?.remove(),xe().length===0){xr();return}let t=document.createElement("div");t.id="save-picker-overlay",t.className="fixed inset-0 bg-black/75 backdrop-blur-sm flex items-center justify-center z-50 p-4";let r=()=>{let o=xe();return o.length===0?'<div class="text-gray-500 text-center py-8 text-sm">\u041D\u0435\u0442 \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0439</div>':o.map(i=>`
          <div class="bg-gray-800 border border-gray-700 rounded-xl p-4 flex items-start gap-4">
            <div class="flex-1 min-w-0">
              <div class="font-semibold text-white truncate">${M(i.playerName||"\u0411\u0435\u0437 \u0438\u043C\u0435\u043D\u0438")}</div>
              <div class="text-sm text-gray-400 mt-0.5">${M(i.packTitle)}</div>
              <div class="text-xs text-gray-500 mt-0.5">
                ${i.charName?M(i.charName)+" \xB7 ":""}\u0412\u043E\u043F\u0440\u043E\u0441 ${M(i.questionProgress)}
              </div>
              <div class="flex items-center gap-3 mt-1.5 text-xs text-gray-500">
                <span class="text-yellow-400">\u2605 ${i.totalStars}</span>
                <span>${jr(i.savedAt)}</span>
              </div>
            </div>
            <div class="flex flex-col gap-2 flex-shrink-0">
              <button data-resume="${i.id}"
                class="py-1.5 px-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg text-sm font-semibold transition">
                \u25B6 \u0418\u0433\u0440\u0430\u0442\u044C
              </button>
              <button data-delete="${i.id}"
                class="py-1.5 px-4 bg-gray-700 hover:bg-red-800 text-gray-300 hover:text-white rounded-lg text-sm transition">
                \u0423\u0434\u0430\u043B\u0438\u0442\u044C
              </button>
            </div>
          </div>
        `).join("")};t.innerHTML=`
    <div class="bg-gray-900 border border-gray-800 rounded-2xl w-full max-w-md shadow-2xl overflow-hidden">
      <div class="flex items-center justify-between px-5 py-4 border-b border-gray-800">
        <h2 class="text-lg font-bold">\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C \u0438\u0433\u0440\u0443</h2>
        <button id="sp-close"
          class="text-gray-400 hover:text-white text-2xl w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-800 transition">
          \xD7
        </button>
      </div>
      <div id="sp-list" class="p-4 space-y-3 max-h-96 overflow-y-auto">
        ${r()}
      </div>
    </div>
  `;let n=()=>{t.querySelectorAll("[data-resume]").forEach(o=>{o.addEventListener("click",()=>{t.remove(),So(o.dataset.resume)})}),t.querySelectorAll("[data-delete]").forEach(o=>{o.addEventListener("click",()=>{Y("\u0423\u0434\u0430\u043B\u0438\u0442\u044C \u044D\u0442\u043E \u0441\u043E\u0445\u0440\u0430\u043D\u0435\u043D\u0438\u0435?",()=>{lt(o.dataset.delete);let i=t.querySelector("#sp-list");i&&(i.innerHTML=r()),n(),xe().length===0&&(t.remove(),xr())})})})};n(),t.querySelector("#sp-close")?.addEventListener("click",()=>t.remove()),t.addEventListener("click",o=>{o.target===t&&t.remove()}),document.body.appendChild(t)}async function ua(){yo(Ve),$o(Ve),await wo(),Ve("home")}document.addEventListener("DOMContentLoaded",()=>{ua()});})();
/*! Bundled license information:

chess.js/dist/esm/chess.js:
  (**
   * @license
   * Copyright (c) 2025, Jeff Hlywa (jhlywa@gmail.com)
   * All rights reserved.
   *
   * Redistribution and use in source and binary forms, with or without
   * modification, are permitted provided that the following conditions are met:
   *
   * 1. Redistributions of source code must retain the above copyright notice,
   *    this list of conditions and the following disclaimer.
   * 2. Redistributions in binary form must reproduce the above copyright notice,
   *    this list of conditions and the following disclaimer in the documentation
   *    and/or other materials provided with the distribution.
   *
   * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
   * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
   * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
   * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
   * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
   * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
   * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
   * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
   * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
   * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
   * POSSIBILITY OF SUCH DAMAGE.
   *)
*/
//# sourceMappingURL=bundle.js.map
